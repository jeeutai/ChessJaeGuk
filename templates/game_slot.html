{% extends "layout.html" %}

{% block extra_css %}
<style>
    .game-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .slot-machine {
        background-color: #222;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        text-align: center;
        margin-bottom: 20px;
    }
    
    .slot-display {
        display: flex;
        justify-content: center;
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .slot-reel {
        background-color: #ddd;
        width: 90px;
        height: 120px;
        margin: 0 10px;
        border-radius: 5px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 50px;
        border: 3px solid #333;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
    }
    
    .slot-reel.spinning {
        background-image: linear-gradient(to bottom, #ddd 0%, #bbb 100%);
        animation: spin 0.2s linear infinite;
    }
    
    @keyframes spin {
        0% { background-position: 0 0; }
        100% { background-position: 0 30px; }
    }
    
    .controls {
        margin: 20px auto;
        max-width: 500px;
    }
    
    .bet-controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .btn-spin {
        background-color: #e74c3c;
        color: white;
        font-size: 1.2rem;
        padding: 15px 30px;
        border-radius: 50px;
        border: none;
        box-shadow: 0 4px 0 #c0392b;
        transition: all 0.2s;
    }
    
    .btn-spin:hover {
        background-color: #c0392b;
        transform: translateY(2px);
        box-shadow: 0 2px 0 #c0392b;
    }
    
    .btn-spin:active {
        transform: translateY(4px);
        box-shadow: none;
    }
    
    .btn-spin:disabled {
        background-color: #95a5a6;
        box-shadow: 0 4px 0 #7f8c8d;
        cursor: not-allowed;
    }
    
    .result-display {
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        text-align: center;
        font-size: 1.2rem;
        font-weight: bold;
        display: none;
    }
    
    .win {
        background-color: #2ecc71;
        color: white;
    }
    
    .lose {
        background-color: #e74c3c;
        color: white;
    }
    
    .jackpot {
        background-color: #f39c12;
        color: white;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .payout-table {
        background-color: #34495e;
        color: white;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .payout-table h4 {
        margin-top: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 10px;
    }
    
    .payout-table .table {
        color: white;
    }
    
    .payout-symbol {
        font-size: 24px;
        vertical-align: middle;
    }
    
    .balance-display {
        background-color: #2c3e50;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        display: inline-block;
        margin-bottom: 15px;
    }
    
    .odds-display {
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        padding: 10px;
        margin-top: 15px;
        font-size: 0.9rem;
    }
    
    .statistics {
        background-color: #f5f5f5;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .statistics h4 {
        margin-top: 0;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="game-container">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="mb-0"><i class="fas fa-slot-machine me-2"></i>ìŠ¬ë¡¯ ë¨¸ì‹ </h2>
            <a href="{{ url_for('games.index') }}" class="btn btn-outline-light btn-sm">
                <i class="fas fa-arrow-left me-1"></i>ê²Œì„ ëª©ë¡
            </a>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle me-2"></i>ê°™ì€ ì´ëª¨ì§€ 3ê°œê°€ ë‚˜ì˜¤ë©´ ìŠ¹ë¦¬! ğŸ’ğŸ’ğŸ’ ì¡°í•©ì´ ë‚˜ì˜¤ë©´ ëŒ€ë°• ë‹¹ì²¨ê¸ˆì´ ì§€ê¸‰ë©ë‹ˆë‹¤.
            </div>
            
            <div class="slot-machine">
                <div class="balance-display">
                    <i class="fas fa-coins me-2"></i>í˜„ì¬ ì”ì•¡: <span id="balance">{{ g.user.balance }}</span>{{ currency_name }}
                </div>
                
                <div class="slot-display">
                    <div class="slot-reel" id="reel1">?</div>
                    <div class="slot-reel" id="reel2">?</div>
                    <div class="slot-reel" id="reel3">?</div>
                </div>
                
                <div class="controls">
                    <div class="bet-controls">
                        <button class="btn btn-outline-light" id="decrease-bet">
                            <i class="fas fa-minus"></i>
                        </button>
                        <div class="input-group" style="width: 200px;">
                            <span class="input-group-text">ë°°íŒ…ê¸ˆì•¡</span>
                            <input type="number" class="form-control text-center" id="bet-amount" value="{{ min_bet }}" min="{{ min_bet }}" max="{{ max_bet }}">
                            <span class="input-group-text">{{ currency_name }}</span>
                        </div>
                        <button class="btn btn-outline-light" id="increase-bet">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <button class="btn-spin" id="spin-button">
                        <i class="fas fa-play me-2"></i>ëŒë¦¬ê¸°
                    </button>
                    
                    <div class="odds-display">
                        ìµœì†Œ ë°°íŒ…: {{ min_bet }}{{ currency_name }} | ìµœëŒ€ ë°°íŒ…: {{ max_bet }}{{ currency_name }}
                    </div>
                </div>
                
                <div class="result-display" id="result"></div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="payout-table">
                        <h4><i class="fas fa-trophy me-2"></i>ë‹¹ì²¨ ì¡°í•©í‘œ</h4>
                        <div class="table-responsive">
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <td><span class="payout-symbol">ğŸ’ğŸ’ğŸ’</span></td>
                                        <td>ì­íŒŸ! ë°°íŒ…ì•¡ì˜ 10ë°°</td>
                                    </tr>
                                    <tr>
                                        <td><span class="payout-symbol">ğŸ‹ğŸ‹ğŸ‹</span></td>
                                        <td>ë°°íŒ…ì•¡ì˜ 5ë°°</td>
                                    </tr>
                                    <tr>
                                        <td><span class="payout-symbol">ğŸŠğŸŠğŸŠ</span></td>
                                        <td>ë°°íŒ…ì•¡ì˜ 4ë°°</td>
                                    </tr>
                                    <tr>
                                        <td><span class="payout-symbol">ğŸ‡ğŸ‡ğŸ‡</span></td>
                                        <td>ë°°íŒ…ì•¡ì˜ 3ë°°</td>
                                    </tr>
                                    <tr>
                                        <td><span class="payout-symbol">ğŸ‰ğŸ‰ğŸ‰</span></td>
                                        <td>ë°°íŒ…ì•¡ì˜ 2ë°°</td>
                                    </tr>
                                    <tr>
                                        <td><span class="payout-symbol">ê°™ì€ ì´ëª¨ì§€ 2ê°œ</span></td>
                                        <td>ë°°íŒ…ì•¡ ê·¸ëŒ€ë¡œ ëŒë ¤ë°›ìŒ</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="statistics">
                        <h4><i class="fas fa-chart-pie me-2"></i>ë‚´ ê²Œì„ í†µê³„</h4>
                        <div class="stat-item">
                            <span>ì´ ê²Œì„ ìˆ˜:</span>
                            <span id="total-games">0</span>
                        </div>
                        <div class="stat-item">
                            <span>ìŠ¹ë¦¬:</span>
                            <span id="total-wins">0</span>
                        </div>
                        <div class="stat-item">
                            <span>íŒ¨ë°°:</span>
                            <span id="total-losses">0</span>
                        </div>
                        <div class="stat-item">
                            <span>ì­íŒŸ íšŸìˆ˜:</span>
                            <span id="total-jackpots">0</span>
                        </div>
                        <div class="stat-item">
                            <span>ìµœëŒ€ ë‹¹ì²¨ê¸ˆ:</span>
                            <span id="max-win">0{{ currency_name }}</span>
                        </div>
                        <div class="stat-item">
                            <span>ì´ íˆ¬ìê¸ˆ:</span>
                            <span id="total-bets">0{{ currency_name }}</span>
                        </div>
                        <div class="stat-item">
                            <span>ì´ íšë“ê¸ˆ:</span>
                            <span id="total-returns">0{{ currency_name }}</span>
                        </div>
                        <div class="stat-item">
                            <span>ìˆ˜ìµë¥ :</span>
                            <span id="roi">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ê²Œì„ ê²°ê³¼ ëª¨ë‹¬ -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">ê²Œì„ ê²°ê³¼</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" id="resultModalBody">
                <div id="resultIcon" class="mb-3" style="font-size: 48px;"></div>
                <h4 id="resultMessage" class="mb-3"></h4>
                <p id="resultDetails" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" id="playAgainBtn" data-bs-dismiss="modal">ë‹¤ì‹œ í”Œë ˆì´</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ë³€ìˆ˜ ì´ˆê¸°í™”
        const reels = [
            document.getElementById('reel1'),
            document.getElementById('reel2'),
            document.getElementById('reel3')
        ];
        
        const spinButton = document.getElementById('spin-button');
        const betAmount = document.getElementById('bet-amount');
        const decreaseBet = document.getElementById('decrease-bet');
        const increaseBet = document.getElementById('increase-bet');
        const balanceDisplay = document.getElementById('balance');
        const resultDisplay = document.getElementById('result');
        
        const minBet = {{ min_bet }};
        const maxBet = {{ max_bet }};
        let balance = {{ g.user.balance }};
        
        // ê²Œì„ í†µê³„
        let stats = {
            totalGames: 0,
            wins: 0,
            losses: 0,
            jackpots: 0,
            maxWin: 0,
            totalBets: 0,
            totalReturns: 0
        };
        
        // ìŠ¬ë¡¯ ì‹¬ë³¼ ë°°ì—´
        const symbols = ['ğŸ’', 'ğŸ‹', 'ğŸŠ', 'ğŸ‡', 'ğŸ‰', 'ğŸŒ', 'ğŸ', 'ğŸ'];
        
        // ìŠ¹ë¦¬ ì¡°í•© ë° ë°°ë‹¹ë¥ 
        const winCombinations = {
            'ğŸ’ğŸ’ğŸ’': 10, // ì­íŒŸ
            'ğŸ‹ğŸ‹ğŸ‹': 5,
            'ğŸŠğŸŠğŸŠ': 4,
            'ğŸ‡ğŸ‡ğŸ‡': 3,
            'ğŸ‰ğŸ‰ğŸ‰': 2
        };
        
        // ë°°íŒ… ê¸ˆì•¡ ì œì–´
        decreaseBet.addEventListener('click', function() {
            let currentBet = parseInt(betAmount.value);
            if (currentBet > minBet) {
                betAmount.value = currentBet - 100;
            }
        });
        
        increaseBet.addEventListener('click', function() {
            let currentBet = parseInt(betAmount.value);
            if (currentBet < maxBet && currentBet < balance) {
                betAmount.value = currentBet + 100;
            }
        });
        
        betAmount.addEventListener('change', function() {
            let value = parseInt(this.value);
            if (value < minBet) this.value = minBet;
            if (value > maxBet) this.value = maxBet;
            if (value > balance) this.value = balance;
        });
        
        // ìŠ¤í•€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        spinButton.addEventListener('click', function() {
            const bet = parseInt(betAmount.value);
            
            // ë°°íŒ… ê¸ˆì•¡ ìœ íš¨ì„± ê²€ì‚¬
            if (isNaN(bet) || bet < minBet || bet > maxBet) {
                alert('ìœ íš¨í•œ ë°°íŒ… ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            // ì”ì•¡ í™•ì¸
            if (bet > balance) {
                alert('ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ë°°íŒ… ê¸ˆì•¡ ì°¨ê°
            balance -= bet;
            balanceDisplay.textContent = balance;
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            stats.totalGames++;
            stats.totalBets += bet;
            
            // ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            spinButton.disabled = true;
            resultDisplay.style.display = 'none';
            
            // ë¦´ì— ìŠ¤í”¼ë‹ í´ë˜ìŠ¤ ì¶”ê°€
            reels.forEach(reel => {
                reel.innerHTML = '?';
                reel.classList.add('spinning');
            });
            
            // ê° ë¦´ ê²°ê³¼ ì„¤ì • (ì‹œê°„ì°¨ë¥¼ ë‘ê³ )
            const results = [];
            
            setTimeout(() => {
                reels[0].classList.remove('spinning');
                results[0] = getRandomSymbol();
                reels[0].innerHTML = results[0];
            }, 1000);
            
            setTimeout(() => {
                reels[1].classList.remove('spinning');
                results[1] = getRandomSymbol();
                reels[1].innerHTML = results[1];
            }, 1500);
            
            setTimeout(() => {
                reels[2].classList.remove('spinning');
                results[2] = getRandomSymbol();
                reels[2].innerHTML = results[2];
                
                // ê²°ê³¼ í™•ì¸ ë° í‘œì‹œ
                setTimeout(() => checkResult(results, bet), 500);
            }, 2000);
        });
        
        // ëœë¤ ì‹¬ë³¼ ì„ íƒ
        function getRandomSymbol() {
            return symbols[Math.floor(Math.random() * symbols.length)];
        }
        
        // ê²°ê³¼ í™•ì¸
        function checkResult(results, bet) {
            const combination = results.join('');
            let multiplier = 0;
            let message = '';
            let isJackpot = false;
            
            // ëª¨ë“  ì‹¬ë³¼ì´ ê°™ì€ ê²½ìš°
            if (results[0] === results[1] && results[1] === results[2]) {
                multiplier = winCombinations[combination] || 1;
                
                if (combination === 'ğŸ’ğŸ’ğŸ’') {
                    message = `ì­íŒŸ! ${bet}${currency_name}ì˜ ${multiplier}ë°°ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`;
                    isJackpot = true;
                    stats.jackpots++;
                } else {
                    message = `ìŠ¹ë¦¬! ${bet}${currency_name}ì˜ ${multiplier}ë°°ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`;
                }
                
                stats.wins++;
            }
            // 2ê°œì˜ ì‹¬ë³¼ë§Œ ê°™ì€ ê²½ìš°
            else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                multiplier = 1;
                message = `2ê°œ ì¼ì¹˜! ë°°íŒ…ê¸ˆ ${bet}${currency_name}ì„ ëŒë ¤ë°›ìŠµë‹ˆë‹¤.`;
                stats.wins++;
            }
            // ëª¨ë‘ ë‹¤ë¥¸ ì‹¬ë³¼
            else {
                message = `ì•„ì‰½ë„¤ìš”. ${bet}${currency_name}ì„ ìƒì—ˆìŠµë‹ˆë‹¤.`;
                stats.losses++;
            }
            
            // ê²°ê³¼ì— ë”°ë¥¸ ì²˜ë¦¬
            if (multiplier > 0) {
                const winAmount = bet * multiplier;
                balance += winAmount;
                balanceDisplay.textContent = balance;
                
                stats.totalReturns += winAmount;
                if (winAmount > stats.maxWin) {
                    stats.maxWin = winAmount;
                }
                
                // ê²°ê³¼ í‘œì‹œ
                resultDisplay.textContent = message;
                resultDisplay.className = 'result-display ' + (isJackpot ? 'jackpot' : 'win');
                
                // ê²°ê³¼ ëª¨ë‹¬
                document.getElementById('resultModalTitle').textContent = isJackpot ? 'ğŸ‰ ëŒ€ë°•! ì­íŒŸ! ğŸ‰' : 'ìŠ¹ë¦¬!';
                document.getElementById('resultIcon').innerHTML = isJackpot ? 'ğŸ’°' : 'ğŸ†';
                document.getElementById('resultMessage').textContent = isJackpot ? 
                    `ì¶•í•˜í•©ë‹ˆë‹¤! ì­íŒŸì— ë‹¹ì²¨ë˜ì…¨ìŠµë‹ˆë‹¤!` : 
                    `ì¶•í•˜í•©ë‹ˆë‹¤! ìŠ¹ë¦¬í•˜ì…¨ìŠµë‹ˆë‹¤!`;
                document.getElementById('resultDetails').textContent = 
                    `${bet}${currency_name}ì˜ ${multiplier}ë°°ì¸ ${winAmount}${currency_name}ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`;
                
                // ì„œë²„ì— ê²°ê³¼ ì €ì¥
                saveGameResult(bet, 'win', winAmount);
            } else {
                // ê²°ê³¼ í‘œì‹œ
                resultDisplay.textContent = message;
                resultDisplay.className = 'result-display lose';
                
                // ê²°ê³¼ ëª¨ë‹¬
                document.getElementById('resultModalTitle').textContent = 'ì•„ì‰½ë„¤ìš”';
                document.getElementById('resultIcon').innerHTML = 'ğŸ˜¢';
                document.getElementById('resultMessage').textContent = 'ì´ë²ˆì—ëŠ” ìš´ì´ ì—†ì—ˆë„¤ìš”!';
                document.getElementById('resultDetails').textContent = 
                    `${bet}${currency_name}ì„ ìƒì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!`;
                
                // ì„œë²„ì— ê²°ê³¼ ì €ì¥
                saveGameResult(bet, 'lose', 0);
            }
            
            // í†µê³„ ì—…ë°ì´íŠ¸ í™”ë©´ì— ë°˜ì˜
            updateStatistics();
            
            // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
            resultModal.show();
            
            // ì¬ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('playAgainBtn').onclick = function() {
                if (balance >= minBet) {
                    spinButton.disabled = false;
                }
            };
            
            // ìŠ¤í•€ ë²„íŠ¼ í™œì„±í™” (ì”ì•¡ì´ ì¶©ë¶„í•œ ê²½ìš°)
            setTimeout(() => {
                resultDisplay.style.display = 'block';
                if (balance >= minBet) {
                    spinButton.disabled = false;
                }
            }, 1000);
        }
        
        // ì„œë²„ì— ê²Œì„ ê²°ê³¼ ì €ì¥
        function saveGameResult(betAmount, result, winAmount) {
            // AJAX ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— ê²°ê³¼ ì „ì†¡
            fetch('{{ url_for("games.place_bet") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'game_id': 'slot',
                    'bet_amount': betAmount,
                    'result': result,
                    'win_amount': winAmount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨:', data.message);
                }
            })
            .catch(error => {
                console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
            });
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            document.getElementById('total-games').textContent = stats.totalGames;
            document.getElementById('total-wins').textContent = stats.wins;
            document.getElementById('total-losses').textContent = stats.losses;
            document.getElementById('total-jackpots').textContent = stats.jackpots;
            document.getElementById('max-win').textContent = `${stats.maxWin}${currency_name}`;
            document.getElementById('total-bets').textContent = `${stats.totalBets}${currency_name}`;
            document.getElementById('total-returns').textContent = `${stats.totalReturns}${currency_name}`;
            
            // ROI ê³„ì‚° (Return on Investment)
            const roi = stats.totalBets > 0 ? ((stats.totalReturns - stats.totalBets) / stats.totalBets * 100).toFixed(2) : '0.00';
            document.getElementById('roi').textContent = `${roi}%`;
        }
    });
</script>
{% endblock %}