{% extends "layout.html" %}

{% block extra_css %}
<style>
  .casino-container {
    max-width: 900px;
    margin: 0 auto;
  }
  
  .games-tab {
    margin-bottom: 20px;
  }
  
  /* Î£∞Î†õ Ïä§ÌÉÄÏùº */
  .roulette-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 30px;
  }
  
  .roulette-wheel {
    width: 300px;
    height: 300px;
    position: relative;
    border-radius: 50%;
    background: #E0E0E0;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    margin-bottom: 20px;
  }
  
  .wheel-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    background: #333;
    border-radius: 50%;
    z-index: 10;
  }
  
  .wheel-segment {
    position: absolute;
    width: 0;
    height: 0;
    border-style: solid;
    transform-origin: 100% 100%;
  }
  
  .wheel-number {
    position: absolute;
    transform-origin: center;
    text-align: center;
    font-weight: bold;
    color: white;
    font-size: 14px;
  }
  
  .wheel-marker {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 30px;
    background: #D50000;
    clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
    z-index: 20;
  }
  
  .betting-board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-gap: 10px;
    margin-top: 20px;
  }
  
  .bet-option {
    padding: 10px;
    text-align: center;
    background: #4CAF50;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .bet-option:hover {
    background: #388E3C;
  }
  
  .bet-option.selected {
    background: #1B5E20;
    font-weight: bold;
    transform: scale(1.05);
  }
  
  .number-board {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    grid-gap: 5px;
    margin-top: 20px;
  }
  
  .number-bet {
    padding: 10px;
    text-align: center;
    background: #1976D2;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .number-bet:hover {
    background: #1565C0;
  }
  
  .number-bet.selected {
    background: #0D47A1;
    font-weight: bold;
    transform: scale(1.05);
  }
  
  /* Ïä¨Î°ØÎ®∏Ïã† Ïä§ÌÉÄÏùº */
  .slot-machine {
    background: linear-gradient(to bottom, #4A148C, #7B1FA2);
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .slot-display {
    background: #E0E0E0;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    justify-content: center;
    width: 300px;
  }
  
  .slot-reel {
    width: 80px;
    height: 120px;
    background: white;
    margin: 0 5px;
    border-radius: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 50px;
    overflow: hidden;
    position: relative;
  }
  
  .slot-symbol {
    position: absolute;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: top 1s cubic-bezier(0.25, 0.1, 0.25, 1);
  }
  
  .slot-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
  
  .spin-button {
    background: #FFC107;
    color: #333;
    font-size: 20px;
    padding: 10px 20px;
    border: none;
    border-radius: 50px;
    margin-top: 20px;
    cursor: pointer;
    width: 200px;
    transition: all 0.2s;
  }
  
  .spin-button:hover {
    background: #FFA000;
    transform: scale(1.05);
  }
  
  .spin-button:disabled {
    background: #9E9E9E;
    cursor: not-allowed;
    transform: none;
  }
  
  .bet-controls {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    width: 100%;
  }
  
  .bet-input {
    flex-grow: 1;
    max-width: 200px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    margin: 0 10px;
  }
  
  .bet-button {
    background: #2196F3;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 20px;
    cursor: pointer;
  }
  
  .result-message {
    margin-top: 20px;
    font-size: 24px;
    font-weight: bold;
    text-align: center;
  }
  
  .win {
    color: #4CAF50;
  }
  
  .lose {
    color: #F44336;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-danger text-white">
      <h2 class="mb-0"><i class="fas fa-dice me-2"></i>Ïπ¥ÏßÄÎÖ∏ Í≤åÏûÑ</h2>
    </div>
    <div class="card-body">
      <div class="balance-display mb-3 p-3 bg-light rounded">
        <h5 class="mb-0"><i class="fas fa-wallet me-2"></i>ÌòÑÏû¨ ÏûîÏï°: <span class="text-primary fw-bold" id="user-balance">{{ g.user.balance }}{{ system_config.get('currency_symbol', 'CM') }}</span></h5>
      </div>
      
      <div class="casino-container">
        <!-- Í≤åÏûÑ ÏÑ†ÌÉù ÌÉ≠ -->
        <ul class="nav nav-tabs games-tab" id="casinoTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="roulette-tab" data-bs-toggle="tab" data-bs-target="#roulette" type="button" role="tab" aria-controls="roulette" aria-selected="true">
              <i class="fas fa-circle-notch me-2"></i>Î£∞Î†õ
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="slot-tab" data-bs-toggle="tab" data-bs-target="#slot" type="button" role="tab" aria-controls="slot" aria-selected="false">
              <i class="fas fa-slot-machine me-2"></i>Ïä¨Î°ØÎ®∏Ïã†
            </button>
          </li>
        </ul>
        
        <div class="tab-content" id="casinoTabContent">
          <!-- Î£∞Î†õ Í≤åÏûÑ -->
          <div class="tab-pane fade show active" id="roulette" role="tabpanel" aria-labelledby="roulette-tab">
            <div class="row">
              <div class="col-md-6">
                <div class="roulette-container">
                  <h4 class="mb-3">Î£∞Î†õ Ìú†</h4>
                  <div class="roulette-wheel">
                    <div class="wheel-marker"></div>
                    <div class="wheel-center"></div>
                    <!-- Î£∞Î†õ ÏÑ∏Í∑∏Î®ºÌä∏Îäî ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏Î°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                  </div>
                  <div class="mt-3" id="roulette-result"></div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-coins me-2"></i>Î≤†ÌåÖ</h4>
                  </div>
                  <div class="card-body">
                    <form id="roulette-bet-form">
                      <div class="mb-3">
                        <label for="roulette-bet-amount" class="form-label">Î∞∞ÌåÖ Í∏àÏï°</label>
                        <div class="input-group">
                          <input type="number" class="form-control" id="roulette-bet-amount" min="500" max="{{ g.user.balance }}" value="500" required>
                          <span class="input-group-text">{{ system_config.get('currency_symbol', 'CM') }}</span>
                        </div>
                        <div class="form-text">ÏµúÏÜå 500{{ system_config.get('currency_symbol', 'CM') }}Î∂ÄÌÑ∞ Î∞∞ÌåÖ Í∞ÄÎä•Ìï©ÎãàÎã§.</div>
                      </div>
                      
                      <div class="mb-3">
                        <label class="form-label">Î≤†ÌåÖ ÏòµÏÖò</label>
                        <div class="betting-board">
                          <div class="bet-option" data-type="odd">ÌôÄÏàò</div>
                          <div class="bet-option" data-type="even">ÏßùÏàò</div>
                          <div class="bet-option" data-type="red">Îπ®Í∞ï</div>
                          <div class="bet-option" data-type="black">Í≤ÄÏ†ï</div>
                          <div class="bet-option" data-type="1-18">1-18</div>
                          <div class="bet-option" data-type="19-36">19-36</div>
                        </div>
                      </div>
                      
                      <div class="mb-3">
                        <label class="form-label">Î≤àÌò∏ Î≤†ÌåÖ (35Î∞∞)</label>
                        <div class="number-board" id="number-board">
                          <!-- Î≤àÌò∏Îäî ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏Î°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                        </div>
                      </div>
                      
                      <div class="mb-3">
                        <div id="bet-summary">ÏÑ†ÌÉùÌïú Î≤†ÌåÖ: <span id="selected-bet">ÏóÜÏùå</span></div>
                      </div>
                      
                      <div class="d-grid">
                        <button type="submit" class="btn btn-danger btn-lg" id="spin-button" disabled>
                          <i class="fas fa-play me-2"></i>Î£∞Î†õ ÎèåÎ¶¨Í∏∞
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Ïä¨Î°ØÎ®∏Ïã† Í≤åÏûÑ -->
          <div class="tab-pane fade" id="slot" role="tabpanel" aria-labelledby="slot-tab">
            <div class="slot-machine">
              <h4 class="text-white mb-3">Ïä¨Î°ØÎ®∏Ïã†</h4>
              
              <div class="slot-display">
                <div class="slot-reel" id="reel1">
                  <div class="slot-symbol">üçí</div>
                </div>
                <div class="slot-reel" id="reel2">
                  <div class="slot-symbol">üçã</div>
                </div>
                <div class="slot-reel" id="reel3">
                  <div class="slot-symbol">üçá</div>
                </div>
              </div>
              
              <div class="slot-controls">
                <div class="bet-controls">
                  <button class="bet-button" id="decrease-bet">-</button>
                  <div class="bet-input">
                    <label for="slot-bet-amount">Î∞∞ÌåÖ:</label>
                    <input type="number" id="slot-bet-amount" min="500" max="{{ g.user.balance }}" value="500" readonly>
                  </div>
                  <button class="bet-button" id="increase-bet">+</button>
                </div>
                
                <button class="spin-button" id="slot-spin-button">
                  <i class="fas fa-sync-alt me-2"></i>Ïä§ÌïÄ!
                </button>
                
                <div class="result-message" id="slot-result"></div>
              </div>
            </div>
            
            <div class="card mt-4">
              <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="fas fa-info-circle me-2"></i>Ïä¨Î°ØÎ®∏Ïã† Î∞∞Îãπ</h4>
              </div>
              <div class="card-body">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Ï°∞Ìï©</th>
                      <th>Î∞∞Îãπ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>üçí üçí üçí</td>
                      <td>Î∞∞ÌåÖÍ∏àÏï°Ïùò 7Î∞∞</td>
                    </tr>
                    <tr>
                      <td>üçã üçã üçã</td>
                      <td>Î∞∞ÌåÖÍ∏àÏï°Ïùò 5Î∞∞</td>
                    </tr>
                    <tr>
                      <td>üçá üçá üçá</td>
                      <td>Î∞∞ÌåÖÍ∏àÏï°Ïùò 3Î∞∞</td>
                    </tr>
                    <tr>
                      <td>üí∞ üí∞ üí∞</td>
                      <td>Î∞∞ÌåÖÍ∏àÏï°Ïùò 10Î∞∞</td>
                    </tr>
                    <tr>
                      <td>ÎèôÏùºÌïú Îëê Í∞úÏùò Ïã¨Î≥º</td>
                      <td>Î∞∞ÌåÖÍ∏àÏï°Ïùò 2Î∞∞</td>
                    </tr>
                    <tr>
                      <td>Í∑∏ Ïô∏</td>
                      <td>Ìå®Î∞∞</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const userBalance = document.getElementById('user-balance');
    
    // Î£∞Î†õ Í≤åÏûÑ
    const rouletteWheel = document.querySelector('.roulette-wheel');
    const spinButton = document.getElementById('spin-button');
    const rouletteBetForm = document.getElementById('roulette-bet-form');
    const rouletteBetAmount = document.getElementById('roulette-bet-amount');
    const betOptions = document.querySelectorAll('.bet-option');
    const numberBoard = document.getElementById('number-board');
    const selectedBet = document.getElementById('selected-bet');
    const rouletteResult = document.getElementById('roulette-result');
    
    let isSpinning = false;
    let selectedBetType = null;
    let selectedNumber = null;
    
    // Î£∞Î†õ Î≤àÌò∏ÏôÄ ÏÉâÏÉÅ
    const rouletteNumbers = [
      { number: 0, color: 'green' },
      { number: 32, color: 'red' }, { number: 15, color: 'black' }, { number: 19, color: 'red' },
      { number: 4, color: 'black' }, { number: 21, color: 'red' }, { number: 2, color: 'black' },
      { number: 25, color: 'red' }, { number: 17, color: 'black' }, { number: 34, color: 'red' },
      { number: 6, color: 'black' }, { number: 27, color: 'red' }, { number: 13, color: 'black' },
      { number: 36, color: 'red' }, { number: 11, color: 'black' }, { number: 30, color: 'red' },
      { number: 8, color: 'black' }, { number: 23, color: 'red' }, { number: 10, color: 'black' },
      { number: 5, color: 'red' }, { number: 24, color: 'black' }, { number: 16, color: 'red' },
      { number: 33, color: 'black' }, { number: 1, color: 'red' }, { number: 20, color: 'black' },
      { number: 14, color: 'red' }, { number: 31, color: 'black' }, { number: 9, color: 'red' },
      { number: 22, color: 'black' }, { number: 18, color: 'red' }, { number: 29, color: 'black' },
      { number: 7, color: 'red' }, { number: 28, color: 'black' }, { number: 12, color: 'red' },
      { number: 35, color: 'black' }, { number: 3, color: 'red' }, { number: 26, color: 'black' }
    ];
    
    // Î£∞Î†õ Ìú† ÏÉùÏÑ±
    function createRouletteWheel() {
      // ÏÑ∏Í∑∏Î®ºÌä∏ Í∞ÅÎèÑ
      const segmentAngle = 360 / rouletteNumbers.length;
      
      rouletteNumbers.forEach((item, index) => {
        const segment = document.createElement('div');
        segment.className = 'wheel-segment';
        
        // ÏÑ∏Í∑∏Î®ºÌä∏ Ïä§ÌÉÄÏùº ÏÑ§Ï†ï
        segment.style.borderWidth = '150px 25px 0';
        segment.style.borderColor = `${item.color} transparent transparent`;
        segment.style.transform = `rotate(${index * segmentAngle}deg)`;
        segment.style.left = '125px';
        segment.style.top = '0';
        
        // Î≤àÌò∏ ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä
        const numberText = document.createElement('div');
        numberText.className = 'wheel-number';
        numberText.textContent = item.number;
        
        // Î≤àÌò∏ ÏúÑÏπò Í≥ÑÏÇ∞
        const angle = (index * segmentAngle + segmentAngle / 2) * Math.PI / 180;
        const distance = 100;
        const x = Math.sin(angle) * distance + 150;
        const y = -Math.cos(angle) * distance + 150;
        
        numberText.style.left = `${x}px`;
        numberText.style.top = `${y}px`;
        numberText.style.transform = `translate(-50%, -50%) rotate(${90 + index * segmentAngle}deg)`;
        
        rouletteWheel.appendChild(segment);
        rouletteWheel.appendChild(numberText);
      });
    }
    
    // Î≤àÌò∏Ìåê ÏÉùÏÑ±
    function createNumberBoard() {
      for (let i = 1; i <= 36; i++) {
        const numberBet = document.createElement('div');
        numberBet.className = 'number-bet';
        numberBet.textContent = i;
        
        // ÌôÄÏàò/ÏßùÏàòÏóê Îî∞Îùº Î∞∞Í≤ΩÏÉâ ÏÑ§Ï†ï
        const color = rouletteNumbers.find(item => item.number === i).color;
        numberBet.style.backgroundColor = color === 'red' ? '#D32F2F' : '#212121';
        
        numberBet.addEventListener('click', function() {
          // Îã§Î•∏ Î≤àÌò∏ ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
          document.querySelectorAll('.number-bet').forEach(btn => btn.classList.remove('selected'));
          betOptions.forEach(option => option.classList.remove('selected'));
          
          numberBet.classList.add('selected');
          selectedBetType = 'number';
          selectedNumber = i;
          selectedBet.textContent = `Î≤àÌò∏ ${i} (35Î∞∞)`;
          spinButton.disabled = false;
        });
        
        numberBoard.appendChild(numberBet);
      }
    }
    
    // Î≤†ÌåÖ ÏòµÏÖò ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    betOptions.forEach(option => {
      option.addEventListener('click', function() {
        // Îã§Î•∏ ÏòµÏÖò ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
        betOptions.forEach(opt => opt.classList.remove('selected'));
        document.querySelectorAll('.number-bet').forEach(btn => btn.classList.remove('selected'));
        
        option.classList.add('selected');
        selectedBetType = option.dataset.type;
        selectedNumber = null;
        
        // Î≤†ÌåÖ ÏÑ§Î™Ö ÏóÖÎç∞Ïù¥Ìä∏
        let betDescription = '';
        switch (selectedBetType) {
          case 'odd':
            betDescription = 'ÌôÄÏàò (1Î∞∞)';
            break;
          case 'even':
            betDescription = 'ÏßùÏàò (1Î∞∞)';
            break;
          case 'red':
            betDescription = 'Îπ®Í∞ï (1Î∞∞)';
            break;
          case 'black':
            betDescription = 'Í≤ÄÏ†ï (1Î∞∞)';
            break;
          case '1-18':
            betDescription = '1-18 (1Î∞∞)';
            break;
          case '19-36':
            betDescription = '19-36 (1Î∞∞)';
            break;
        }
        
        selectedBet.textContent = betDescription;
        spinButton.disabled = false;
      });
    });
    
    // Î£∞Î†õ Ìèº Ï†úÏ∂ú
    rouletteBetForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (isSpinning) return;
      
      const betAmount = parseInt(rouletteBetAmount.value);
      
      if (isNaN(betAmount) || betAmount < 500) {
        alert('ÏµúÏÜå 500{{ system_config.get('currency_symbol', 'CM') }} Ïù¥ÏÉÅ Î∞∞ÌåÖÌï¥Ïïº Ìï©ÎãàÎã§.');
        return;
      }
      
      if (betAmount > parseInt(userBalance.textContent.replace(/[^0-9]/g, ''))) {
        alert('ÏûîÏï°Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.');
        return;
      }
      
      if (!selectedBetType) {
        alert('Î≤†ÌåÖ ÏòµÏÖòÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }
      
      // Î£∞Î†õ Ïä§ÌïÄ ÏãúÏûë
      spinRouletteWheel(betAmount);
    });
    
    // Î£∞Î†õ Ïä§ÌïÄ
    function spinRouletteWheel(betAmount) {
      isSpinning = true;
      spinButton.disabled = true;
      rouletteResult.textContent = '';
      
      // ÎûúÎç§ ÌöåÏ†Ñ Í∞ÅÎèÑ (10-20 ÌöåÏ†Ñ + ÎãπÏ≤® ÏúÑÏπò)
      const randomIndex = Math.floor(Math.random() * rouletteNumbers.length);
      const winningNumber = rouletteNumbers[randomIndex].number;
      const spinDegrees = 3600 + (randomIndex * (360 / rouletteNumbers.length));
      
      // Î£∞Î†õ Ïï†ÎãàÎ©îÏù¥ÏÖò
      rouletteWheel.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
      rouletteWheel.style.transform = `rotate(${spinDegrees}deg)`;
      
      // Ïä§ÌïÄ ÏôÑÎ£å ÌõÑ Í≤∞Í≥º Ï≤òÎ¶¨
      setTimeout(() => {
        isSpinning = false;
        spinButton.disabled = false;
        
        let result = '';
        let winAmount = 0;
        
        // Î≤†ÌåÖ Í≤∞Í≥º Í≥ÑÏÇ∞
        if (selectedBetType === 'number' && selectedNumber === winningNumber) {
          // Î≤àÌò∏ Ï†ïÌôïÌûà ÎßûÏ∑ÑÏùÑ Îïå (35Î∞∞)
          winAmount = betAmount * 35;
          result = 'big_win';
          rouletteResult.innerHTML = `<div class="alert alert-success">
            <h4>ÎãπÏ≤®! Î≤àÌò∏ ${winningNumber}</h4>
            <p>Î≤†ÌåÖ: ${betAmount}{{ system_config.get('currency_symbol', 'CM') }}, ÎãπÏ≤®Í∏à: ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} (35Î∞∞)</p>
          </div>`;
        } else if (selectedBetType === 'odd' && winningNumber !== 0 && winningNumber % 2 === 1) {
          // ÌôÄÏàò Î≤†ÌåÖ ÏÑ±Í≥µ (1Î∞∞)
          winAmount = betAmount * 2;
          result = 'small_win';
          rouletteResult.innerHTML = `<div class="alert alert-success">
            <h4>ÎãπÏ≤®! Î≤àÌò∏ ${winningNumber} (ÌôÄÏàò)</h4>
            <p>Î≤†ÌåÖ: ${betAmount}{{ system_config.get('currency_symbol', 'CM') }}, ÎãπÏ≤®Í∏à: ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} (2Î∞∞)</p>
          </div>`;
        } else if (selectedBetType === 'even' && winningNumber !== 0 && winningNumber % 2 === 0) {
          // ÏßùÏàò Î≤†ÌåÖ ÏÑ±Í≥µ (1Î∞∞)
          winAmount = betAmount * 2;
          result = 'small_win';
          rouletteResult.innerHTML = `<div class="alert alert-success">
            <h4>ÎãπÏ≤®! Î≤àÌò∏ ${winningNumber} (ÏßùÏàò)</h4>
            <p>Î≤†ÌåÖ: ${betAmount}{{ system_config.get('currency_symbol', 'CM') }}, ÎãπÏ≤®Í∏à: ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} (2Î∞∞)</p>
          </div>`;
        } else if (selectedBetType === 'red' && rouletteNumbers.find(item => item.number === winningNumber).color === 'red') {
          // Îπ®Í∞ÑÏÉâ Î≤†ÌåÖ ÏÑ±Í≥µ (1Î∞∞)
          winAmount = betAmount * 2;
          result = 'small_win';
          rouletteResult.innerHTML = `<div class="alert alert-success">
            <h4>ÎãπÏ≤®! Î≤àÌò∏ ${winningNumber} (Îπ®Í∞ï)</h4>
            <p>Î≤†ÌåÖ: ${betAmount}{{ system_config.get('currency_symbol', 'CM') }}, ÎãπÏ≤®Í∏à: ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} (2Î∞∞)</p>
          </div>`;
        } else if (selectedBetType === 'black' && rouletteNumbers.find(item => item.number === winningNumber).color === 'black') {
          // Í≤ÄÏùÄÏÉâ Î≤†ÌåÖ ÏÑ±Í≥µ (1Î∞∞)
          winAmount = betAmount * 2;
          result = 'small_win';
          rouletteResult.innerHTML = `<div class="alert alert-success">
            <h4>ÎãπÏ≤®! Î≤àÌò∏ ${winningNumber} (Í≤ÄÏ†ï)</h4>
            <p>Î≤†ÌåÖ: ${betAmount}{{ system_config.get('currency_symbol', 'CM') }}, ÎãπÏ≤®Í∏à: ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} (2Î∞∞)</p>
          </div>`;
        } else if (selectedBetType === '1-18' && winningNumber >= 1 && winningNumber <= 18) {
          // 1-18 Î≤†ÌåÖ ÏÑ±Í≥µ (1Î∞∞)
          winAmount = betAmount * 2;
          result = 'small_win';
          rouletteResult.innerHTML = `<div class="alert alert-success">
            <h4>ÎãπÏ≤®! Î≤àÌò∏ ${winningNumber} (1-18)</h4>
            <p>Î≤†ÌåÖ: ${betAmount}{{ system_config.get('currency_symbol', 'CM') }}, ÎãπÏ≤®Í∏à: ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} (2Î∞∞)</p>
          </div>`;
        } else if (selectedBetType === '19-36' && winningNumber >= 19 && winningNumber <= 36) {
          // 19-36 Î≤†ÌåÖ ÏÑ±Í≥µ (1Î∞∞)
          winAmount = betAmount * 2;
          result = 'small_win';
          rouletteResult.innerHTML = `<div class="alert alert-success">
            <h4>ÎãπÏ≤®! Î≤àÌò∏ ${winningNumber} (19-36)</h4>
            <p>Î≤†ÌåÖ: ${betAmount}{{ system_config.get('currency_symbol', 'CM') }}, ÎãπÏ≤®Í∏à: ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} (2Î∞∞)</p>
          </div>`;
        } else {
          // Ìå®Î∞∞
          winAmount = 0;
          result = 'lose';
          rouletteResult.innerHTML = `<div class="alert alert-danger">
            <h4>Ïã§Ìå®! Î≤àÌò∏ ${winningNumber}</h4>
            <p>Î≤†ÌåÖ: ${betAmount}{{ system_config.get('currency_symbol', 'CM') }}, ÎãπÏ≤®Í∏à: 0{{ system_config.get('currency_symbol', 'CM') }}</p>
          </div>`;
        }
        
        // ÏÑúÎ≤ÑÏóê Í≤åÏûÑ Í≤∞Í≥º Ï†ÑÏÜ°
        fetch('{{ url_for("games.place_bet") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `game_id=casino&bet_amount=${betAmount}&game_data=roulette_${winningNumber}`
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // ÏûîÏï° ÏóÖÎç∞Ïù¥Ìä∏
            userBalance.textContent = `${data.new_balance}{{ system_config.get('currency_symbol', 'CM') }}`;
          } else {
            alert(data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Í≤åÏûÑ Í≤∞Í≥ºÎ•º Ï≤òÎ¶¨ÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        });
      }, 5000);
    }
    
    // Î£∞Î†õ Ìú† Î∞è Î≤àÌò∏Ìåê ÏÉùÏÑ±
    createRouletteWheel();
    createNumberBoard();
    
    // Ïä¨Î°ØÎ®∏Ïã† Í≤åÏûÑ
    const slotReels = [
      document.getElementById('reel1').querySelector('.slot-symbol'),
      document.getElementById('reel2').querySelector('.slot-symbol'),
      document.getElementById('reel3').querySelector('.slot-symbol')
    ];
    const decreaseBetBtn = document.getElementById('decrease-bet');
    const increaseBetBtn = document.getElementById('increase-bet');
    const slotBetAmount = document.getElementById('slot-bet-amount');
    const slotSpinButton = document.getElementById('slot-spin-button');
    const slotResult = document.getElementById('slot-result');
    
    let isSlotSpinning = false;
    const symbols = ['üçí', 'üçã', 'üçá', 'üí∞', 'üçé', '‚≠ê'];
    
    // Î≤†ÌåÖ Í∏àÏï° Ï°∞Ï†à
    decreaseBetBtn.addEventListener('click', function() {
      let bet = parseInt(slotBetAmount.value);
      if (bet > 500) {
        bet -= 500;
        slotBetAmount.value = bet;
      }
    });
    
    increaseBetBtn.addEventListener('click', function() {
      let bet = parseInt(slotBetAmount.value);
      const max = parseInt(userBalance.textContent.replace(/[^0-9]/g, ''));
      
      if (bet + 500 <= max) {
        bet += 500;
        slotBetAmount.value = bet;
      }
    });
    
    // Ïä¨Î°ØÎ®∏Ïã† Ïä§ÌïÄ
    slotSpinButton.addEventListener('click', function() {
      if (isSlotSpinning) return;
      
      const betAmount = parseInt(slotBetAmount.value);
      
      if (isNaN(betAmount) || betAmount < 500) {
        alert('ÏµúÏÜå 500{{ system_config.get('currency_symbol', 'CM') }} Ïù¥ÏÉÅ Î∞∞ÌåÖÌï¥Ïïº Ìï©ÎãàÎã§.');
        return;
      }
      
      if (betAmount > parseInt(userBalance.textContent.replace(/[^0-9]/g, ''))) {
        alert('ÏûîÏï°Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.');
        return;
      }
      
      spinSlotMachine(betAmount);
    });
    
    // Ïä¨Î°ØÎ®∏Ïã† Ïä§ÌïÄ Ìï®Ïàò
    function spinSlotMachine(betAmount) {
      isSlotSpinning = true;
      slotSpinButton.disabled = true;
      slotResult.textContent = '';
      
      // Í∞Å Î¶¥ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
      const finalSymbols = [];
      
      slotReels.forEach((reel, index) => {
        // 0~5 ÏÇ¨Ïù¥Ïùò ÎûúÎç§ Ïù∏Îç±Ïä§ ÏÉùÏÑ±
        const randomIndex = Math.floor(Math.random() * symbols.length);
        const symbol = symbols[randomIndex];
        finalSymbols.push(symbol);
        
        // Î¶¥ Ïï†ÎãàÎ©îÏù¥ÏÖò
        const positions = [];
        for (let i = 0; i < 20 + index * 5; i++) {
          const randomSymbol = symbols[Math.floor(Math.random() * symbols.length)];
          positions.push(randomSymbol);
        }
        positions.push(symbol); // ÏµúÏ¢Ö Ïã¨Î≥º
        
        let currentPosition = 0;
        
        // ÌöåÏ†Ñ Ïï†ÎãàÎ©îÏù¥ÏÖò
        const spinInterval = setInterval(() => {
          if (currentPosition >= positions.length) {
            clearInterval(spinInterval);
            return;
          }
          
          reel.textContent = positions[currentPosition];
          currentPosition++;
        }, 100);
        
        // ÌöåÏ†Ñ Ï¢ÖÎ£å ÌÉÄÏù¥Î∞ç ÏÑ§Ï†ï (Î¶¥ÎßàÎã§ Îã§Î•¥Í≤å)
        setTimeout(() => {
          clearInterval(spinInterval);
          reel.textContent = symbol;
          
          // ÎßàÏßÄÎßâ Î¶¥Ïù¥ Î©àÏ∑ÑÏùÑ Îïå Í≤∞Í≥º Í≥ÑÏÇ∞
          if (index === slotReels.length - 1) {
            setTimeout(() => checkSlotResult(finalSymbols, betAmount), 500);
          }
        }, 1000 + (index * 500));
      });
    }
    
    // Ïä¨Î°ØÎ®∏Ïã† Í≤∞Í≥º ÌôïÏù∏
    function checkSlotResult(symbols, betAmount) {
      isSlotSpinning = false;
      slotSpinButton.disabled = false;
      
      let result = '';
      let winAmount = 0;
      let message = '';
      
      // Î™®Îì† Ïã¨Î≥ºÏù¥ Í∞ôÏùÄ Í≤ΩÏö∞
      if (symbols[0] === symbols[1] && symbols[1] === symbols[2]) {
        // Ïã¨Î≥ºÏóê Îî∞Î•∏ Î∞∞Îãπ Í≥ÑÏÇ∞
        switch (symbols[0]) {
          case 'üçí':
            winAmount = betAmount * 7;
            message = `3Í∞úÏùò üçí! ${betAmount}{{ system_config.get('currency_symbol', 'CM') }} Î≤†ÌåÖÏúºÎ°ú ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} ÌöçÎìù! (7Î∞∞)`;
            break;
          case 'üçã':
            winAmount = betAmount * 5;
            message = `3Í∞úÏùò üçã! ${betAmount}{{ system_config.get('currency_symbol', 'CM') }} Î≤†ÌåÖÏúºÎ°ú ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} ÌöçÎìù! (5Î∞∞)`;
            break;
          case 'üçá':
            winAmount = betAmount * 3;
            message = `3Í∞úÏùò üçá! ${betAmount}{{ system_config.get('currency_symbol', 'CM') }} Î≤†ÌåÖÏúºÎ°ú ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} ÌöçÎìù! (3Î∞∞)`;
            break;
          case 'üí∞':
            winAmount = betAmount * 10;
            message = `3Í∞úÏùò üí∞! ÎåÄÎ∞ï! ${betAmount}{{ system_config.get('currency_symbol', 'CM') }} Î≤†ÌåÖÏúºÎ°ú ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} ÌöçÎìù! (10Î∞∞)`;
            break;
          default:
            winAmount = betAmount * 2;
            message = `3Í∞úÏùò ${symbols[0]}! ${betAmount}{{ system_config.get('currency_symbol', 'CM') }} Î≤†ÌåÖÏúºÎ°ú ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} ÌöçÎìù! (2Î∞∞)`;
        }
        
        result = 'win';
        slotResult.textContent = message;
        slotResult.className = 'result-message win';
      }
      // Îëê Í∞úÏùò Í∞ôÏùÄ Ïã¨Î≥º
      else if (
        symbols[0] === symbols[1] ||
        symbols[1] === symbols[2] ||
        symbols[0] === symbols[2]
      ) {
        winAmount = betAmount * 2;
        message = `2Í∞úÏùò Í∞ôÏùÄ Ïã¨Î≥º! ${betAmount}{{ system_config.get('currency_symbol', 'CM') }} Î≤†ÌåÖÏúºÎ°ú ${winAmount}{{ system_config.get('currency_symbol', 'CM') }} ÌöçÎìù! (2Î∞∞)`;
        result = 'small_win';
        slotResult.textContent = message;
        slotResult.className = 'result-message win';
      }
      // Î™®Îëê Îã§Î•∏ Í≤ΩÏö∞
      else {
        message = `ÏïÑÏâΩÍ≤åÎèÑ Ïã§Ìå®! ${betAmount}{{ system_config.get('currency_symbol', 'CM') }}ÏùÑ ÏûÉÏóàÏäµÎãàÎã§.`;
        result = 'lose';
        slotResult.textContent = message;
        slotResult.className = 'result-message lose';
      }
      
      // ÏÑúÎ≤ÑÏóê Í≤åÏûÑ Í≤∞Í≥º Ï†ÑÏÜ°
      fetch('{{ url_for("games.place_bet") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `game_id=casino&bet_amount=${betAmount}&game_data=slot`
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // ÏûîÏï° ÏóÖÎç∞Ïù¥Ìä∏
          userBalance.textContent = `${data.new_balance}{{ system_config.get('currency_symbol', 'CM') }}`;
        } else {
          alert(data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Í≤åÏûÑ Í≤∞Í≥ºÎ•º Ï≤òÎ¶¨ÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      });
    }
  });
</script>
{% endblock %}
