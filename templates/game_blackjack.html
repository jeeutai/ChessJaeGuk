{% extends "layout.html" %}

{% block extra_css %}
<style>
    .game-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .blackjack-table {
        background-color: #056b1a;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        position: relative;
        margin-bottom: 20px;
    }
    
    .blackjack-table::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 15px;
        border: 8px solid #7b432c;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        pointer-events: none;
    }
    
    .dealer-area, .player-area {
        background-color: rgba(0,0,0,0.2);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .area-label {
        background-color: rgba(0,0,0,0.4);
        color: white;
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        margin-bottom: 10px;
        font-weight: bold;
    }
    
    .cards-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        min-height: 160px;
    }
    
    .card {
        width: 120px;
        height: 160px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 5px;
        font-weight: bold;
        position: relative;
        transition: transform 0.3s ease;
    }
    
    .card.hidden {
        background-image: repeating-linear-gradient(
            45deg,
            #b71c1c,
            #b71c1c 10px,
            #e53935 10px,
            #e53935 20px
        );
    }
    
    .card.hidden .card-value, .card.hidden .card-suit {
        visibility: hidden;
    }
    
    .card:hover {
        transform: translateY(-5px);
    }
    
    .card-top, .card-bottom {
        display: flex;
        justify-content: space-between;
        padding: 5px;
    }
    
    .card-bottom {
        transform: rotate(180deg);
    }
    
    .card-center {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-grow: 1;
        font-size: 30px;
    }
    
    .card-value {
        font-size: 24px;
    }
    
    .card-suit {
        font-size: 24px;
    }
    
    .red {
        color: #d32f2f;
    }
    
    .black {
        color: #212121;
    }
    
    .score-display {
        background-color: rgba(0,0,0,0.5);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        display: inline-block;
        margin-left: 15px;
        font-weight: bold;
    }
    
    .actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
    }
    
    .action-btn {
        padding: 10px 20px;
        font-size: 1.1rem;
        border-radius: 30px;
        border: none;
        color: white;
        font-weight: bold;
        box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        transition: all 0.2s;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
    }
    
    .action-btn:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 rgba(0,0,0,0.2);
    }
    
    .action-btn:disabled {
        background-color: #b0bec5;
        color: #78909c;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn-hit {
        background-color: #2196f3;
    }
    
    .btn-stand {
        background-color: #f44336;
    }
    
    .btn-double {
        background-color: #ff9800;
    }
    
    .btn-deal {
        background-color: #4caf50;
    }
    
    .bet-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .balance-display {
        background-color: rgba(0,0,0,0.5);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        margin-bottom: 20px;
        display: inline-block;
    }
    
    .result-message {
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin: 20px auto;
        max-width: 400px;
        display: none;
    }
    
    .result-message.win {
        background-color: #4caf50;
    }
    
    .result-message.lose {
        background-color: #f44336;
    }
    
    .result-message.push {
        background-color: #ff9800;
    }
    
    .result-message.blackjack {
        background-color: #9c27b0;
    }
    
    .chip {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        border: 2px dashed rgba(255,255,255,0.5);
        transition: all 0.2s;
    }
    
    .chip:hover {
        transform: scale(1.1);
    }
    
    .chip.selected {
        border: 2px solid white;
        box-shadow: 0 0 10px rgba(255,255,255,0.7);
    }
    
    .chip-100 {
        background-color: #1976d2;
    }
    
    .chip-500 {
        background-color: #d32f2f;
    }
    
    .chip-1000 {
        background-color: #388e3c;
    }
    
    .chip-5000 {
        background-color: #7b1fa2;
    }
    
    .chip-10000 {
        background-color: #f57c00;
    }
    
    .bet-amount {
        background-color: rgba(0,0,0,0.5);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        min-width: 200px;
        text-align: center;
    }
    
    .game-status {
        text-align: center;
        margin-bottom: 20px;
        color: white;
        font-weight: bold;
    }
    
    .statistics {
        background-color: #f5f5f5;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .statistics h4 {
        margin-top: 0;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    
    .rules-section {
        background-color: #fff;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .rules-section h4 {
        margin-top: 0;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }
    
    .rule-item {
        margin-bottom: 10px;
    }
    
    .card-text {
        text-align: center;
        font-weight: bold;
        font-size: 32px;
    }
</style>
{% endblock %}

{% block content %}
<div class="game-container">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="mb-0"><i class="fas fa-crown me-2"></i>ë¸”ë™ì­</h2>
            <a href="{{ url_for('games.index') }}" class="btn btn-outline-light btn-sm">
                <i class="fas fa-arrow-left me-1"></i>ê²Œì„ ëª©ë¡
            </a>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle me-2"></i>ì¹´ë“œì˜ í•©ì´ 21ì— ê°€ê¹ê²Œ ë§Œë“¤ì–´ ë”œëŸ¬ë¥¼ ì´ê¸°ëŠ” ê²Œì„ì…ë‹ˆë‹¤. 21ì„ ì´ˆê³¼í•˜ë©´ ë²„ìŠ¤íŠ¸(íŒ¨ë°°)í•©ë‹ˆë‹¤.
            </div>
            
            <div class="blackjack-table">
                <div class="text-center">
                    <div class="balance-display">
                        <i class="fas fa-coins me-2"></i>í˜„ì¬ ì”ì•¡: <span id="balance">{{ g.user.balance }}</span>{{ currency_name }}
                    </div>
                </div>
                
                <div class="dealer-area">
                    <div class="area-label">ë”œëŸ¬</div>
                    <span class="score-display">ì ìˆ˜: <span id="dealer-score">0</span></span>
                    <div class="cards-container" id="dealer-cards"></div>
                </div>
                
                <div class="player-area">
                    <div class="area-label">í”Œë ˆì´ì–´</div>
                    <span class="score-display">ì ìˆ˜: <span id="player-score">0</span></span>
                    <div class="cards-container" id="player-cards"></div>
                </div>
                
                <div class="result-message" id="result-message"></div>
                
                <div class="game-status" id="game-status">ë² íŒ… ê¸ˆì•¡ì„ ì„ íƒí•˜ê³  ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”!</div>
                
                <div class="bet-controls">
                    <div class="chip chip-100" data-value="100">100</div>
                    <div class="chip chip-500" data-value="500">500</div>
                    <div class="chip chip-1000" data-value="1000">1K</div>
                    <div class="chip chip-5000" data-value="5000">5K</div>
                    <div class="chip chip-10000" data-value="10000">10K</div>
                    <div class="bet-amount">ë² íŒ…: <span id="bet-amount">0</span>{{ currency_name }}</div>
                    <button class="btn btn-outline-light btn-sm" id="clear-bet">
                        <i class="fas fa-times me-1"></i>ì´ˆê¸°í™”
                    </button>
                </div>
                
                <div class="actions">
                    <button class="action-btn btn-deal" id="deal-btn">
                        <i class="fas fa-play me-1"></i>ê²Œì„ ì‹œì‘
                    </button>
                    <button class="action-btn btn-hit" id="hit-btn" disabled>
                        <i class="fas fa-plus me-1"></i>íˆíŠ¸
                    </button>
                    <button class="action-btn btn-stand" id="stand-btn" disabled>
                        <i class="fas fa-hand-paper me-1"></i>ìŠ¤íƒ ë“œ
                    </button>
                    <button class="action-btn btn-double" id="double-btn" disabled>
                        <i class="fas fa-coins me-1"></i>ë”ë¸” ë‹¤ìš´
                    </button>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="rules-section">
                        <h4><i class="fas fa-book me-2"></i>ê²Œì„ ê·œì¹™</h4>
                        <div class="rule-item">
                            <strong>ëª©í‘œ:</strong> ì¹´ë“œ í•©ê³„ê°€ 21ì— ê°€ê¹Œìš°ë©´ì„œ ë”œëŸ¬ë³´ë‹¤ ë†’ì€ í•©ê³„ë¥¼ ê°€ì§€ëŠ” ê²ƒ
                        </div>
                        <div class="rule-item">
                            <strong>ì¹´ë“œ ê°’:</strong> ìˆ«ì ì¹´ë“œëŠ” í‘œì‹œëœ ê°’, í˜ì´ìŠ¤ ì¹´ë“œ(J, Q, K)ëŠ” 10, ì—ì´ìŠ¤(A)ëŠ” 1 ë˜ëŠ” 11
                        </div>
                        <div class="rule-item">
                            <strong>ë¸”ë™ì­:</strong> ì²˜ìŒ 2ì¥ì˜ ì¹´ë“œ í•©ì´ 21ì¸ ê²½ìš° (A + 10,J,Q,K), ë°°íŒ…ì•¡ì˜ 2.5ë°° íšë“
                        </div>
                        <div class="rule-item">
                            <strong>íˆíŠ¸:</strong> ì¶”ê°€ ì¹´ë“œë¥¼ ë°›ìŒ
                        </div>
                        <div class="rule-item">
                            <strong>ìŠ¤íƒ ë“œ:</strong> ë” ì´ìƒ ì¹´ë“œë¥¼ ë°›ì§€ ì•Šê³  í˜„ì¬ í•©ê³„ë¡œ ìŠ¹ë¶€
                        </div>
                        <div class="rule-item">
                            <strong>ë”ë¸” ë‹¤ìš´:</strong> ë² íŒ…ì•¡ì„ ë‘ ë°°ë¡œ ëŠ˜ë¦¬ê³  ì¹´ë“œë¥¼ í•œ ì¥ë§Œ ë” ë°›ìŒ
                        </div>
                        <div class="rule-item">
                            <strong>ë”œëŸ¬ ê·œì¹™:</strong> ë”œëŸ¬ëŠ” í•©ê³„ê°€ 16 ì´í•˜ì´ë©´ ë°˜ë“œì‹œ íˆíŠ¸, 17 ì´ìƒì´ë©´ ë°˜ë“œì‹œ ìŠ¤íƒ ë“œ
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="statistics">
                        <h4><i class="fas fa-chart-pie me-2"></i>ë‚´ ê²Œì„ í†µê³„</h4>
                        <div class="stat-item">
                            <span>ì´ ê²Œì„ ìˆ˜:</span>
                            <span id="total-games">0</span>
                        </div>
                        <div class="stat-item">
                            <span>ìŠ¹ë¦¬:</span>
                            <span id="total-wins">0</span>
                        </div>
                        <div class="stat-item">
                            <span>íŒ¨ë°°:</span>
                            <span id="total-losses">0</span>
                        </div>
                        <div class="stat-item">
                            <span>ë¬´ìŠ¹ë¶€:</span>
                            <span id="total-pushes">0</span>
                        </div>
                        <div class="stat-item">
                            <span>ë¸”ë™ì­ íšŸìˆ˜:</span>
                            <span id="total-blackjacks">0</span>
                        </div>
                        <div class="stat-item">
                            <span>ìµœëŒ€ ë‹¹ì²¨ê¸ˆ:</span>
                            <span id="max-win">0{{ currency_name }}</span>
                        </div>
                        <div class="stat-item">
                            <span>ì´ íˆ¬ìê¸ˆ:</span>
                            <span id="total-bets">0{{ currency_name }}</span>
                        </div>
                        <div class="stat-item">
                            <span>ì´ íšë“ê¸ˆ:</span>
                            <span id="total-returns">0{{ currency_name }}</span>
                        </div>
                        <div class="stat-item">
                            <span>ìˆ˜ìµë¥ :</span>
                            <span id="roi">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ê²Œì„ ê²°ê³¼ ëª¨ë‹¬ -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">ê²Œì„ ê²°ê³¼</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" id="resultModalBody">
                <div id="resultIcon" class="mb-3" style="font-size: 48px;"></div>
                <h4 id="resultMessage" class="mb-3"></h4>
                <p id="resultDetails" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" id="playAgainBtn" data-bs-dismiss="modal">ë‹¤ì‹œ í”Œë ˆì´</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ê²Œì„ ìƒíƒœ ë° ë°ì´í„°
        const state = {
            deck: [],
            dealerCards: [],
            playerCards: [],
            dealerScore: 0,
            playerScore: 0,
            dealerHiddenCard: null,
            currentBet: 0,
            balance: {{ g.user.balance }},
            gamePhase: 'betting', // betting, dealing, player-turn, dealer-turn, game-over
            minBet: {{ min_bet }},
            maxBet: {{ max_bet }}
        };
        
        // ê²Œì„ í†µê³„
        const stats = {
            totalGames: 0,
            wins: 0,
            losses: 0,
            pushes: 0,
            blackjacks: 0,
            maxWin: 0,
            totalBets: 0,
            totalReturns: 0
        };
        
        // DOM ìš”ì†Œ
        const dealerCardsContainer = document.getElementById('dealer-cards');
        const playerCardsContainer = document.getElementById('player-cards');
        const dealerScoreDisplay = document.getElementById('dealer-score');
        const playerScoreDisplay = document.getElementById('player-score');
        const resultMessage = document.getElementById('result-message');
        const gameStatus = document.getElementById('game-status');
        const balanceDisplay = document.getElementById('balance');
        const betAmountDisplay = document.getElementById('bet-amount');
        const dealBtn = document.getElementById('deal-btn');
        const hitBtn = document.getElementById('hit-btn');
        const standBtn = document.getElementById('stand-btn');
        const doubleBtn = document.getElementById('double-btn');
        const chips = document.querySelectorAll('.chip');
        const clearBetBtn = document.getElementById('clear-bet');
        
        // ì¹´ë“œ ìƒì„±
        function createDeck() {
            const suits = ['â™¥', 'â™¦', 'â™ ', 'â™£'];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            let deck = [];
            
            for (let suit of suits) {
                for (let value of values) {
                    deck.push({
                        suit,
                        value,
                        color: (suit === 'â™¥' || suit === 'â™¦') ? 'red' : 'black'
                    });
                }
            }
            
            return shuffleDeck(deck);
        }
        
        // ì¹´ë“œ ì„ê¸°
        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }
        
        // ì¹´ë“œ ê°€ì ¸ì˜¤ê¸°
        function drawCard(hidden = false) {
            if (state.deck.length === 0) {
                state.deck = createDeck();
            }
            
            const card = state.deck.pop();
            card.hidden = hidden;
            return card;
        }
        
        // ì¹´ë“œ ê°’ ê³„ì‚°
        function getCardValue(card) {
            if (card.value === 'A') return 11;
            if (['K', 'Q', 'J'].includes(card.value)) return 10;
            return parseInt(card.value);
        }
        
        // í•¸ë“œ ì ìˆ˜ ê³„ì‚°
        function calculateHandScore(cards) {
            let score = 0;
            let aces = 0;
            
            for (let card of cards) {
                if (!card.hidden) {
                    const value = getCardValue(card);
                    if (card.value === 'A') aces++;
                    score += value;
                }
            }
            
            // Ace ê°’ ì¡°ì • (1 ë˜ëŠ” 11)
            while (score > 21 && aces > 0) {
                score -= 10; // 11ì—ì„œ 1ë¡œ ë³€ê²½ (ì°¨ì´ 10)
                aces--;
            }
            
            return score;
        }
        
        // ì¹´ë“œ ë Œë”ë§
        function renderCard(card, container) {
            const cardElement = document.createElement('div');
            cardElement.className = 'card' + (card.hidden ? ' hidden' : '');
            
            if (!card.hidden) {
                const colorClass = card.color;
                
                const topValue = document.createElement('div');
                topValue.className = `card-top ${colorClass}`;
                topValue.innerHTML = `
                    <span class="card-value">${card.value}</span>
                    <span class="card-suit">${card.suit}</span>
                `;
                
                const centerValue = document.createElement('div');
                centerValue.className = `card-center ${colorClass}`;
                centerValue.innerHTML = `<span class="card-suit">${card.suit}</span>`;
                
                const bottomValue = document.createElement('div');
                bottomValue.className = `card-bottom ${colorClass}`;
                bottomValue.innerHTML = `
                    <span class="card-value">${card.value}</span>
                    <span class="card-suit">${card.suit}</span>
                `;
                
                cardElement.appendChild(topValue);
                cardElement.appendChild(centerValue);
                cardElement.appendChild(bottomValue);
            } else {
                const cardText = document.createElement('div');
                cardText.className = 'card-text';
                cardText.textContent = '?';
                cardElement.appendChild(cardText);
            }
            
            container.appendChild(cardElement);
        }
        
        // ê²Œì„ ì´ˆê¸°í™”
        function initGame() {
            state.deck = createDeck();
            clearTable();
            updateGameStatus('ë² íŒ… ê¸ˆì•¡ì„ ì„ íƒí•˜ê³  ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”!');
            dealBtn.disabled = state.currentBet < state.minBet;
            hitBtn.disabled = true;
            standBtn.disabled = true;
            doubleBtn.disabled = true;
            state.gamePhase = 'betting';
        }
        
        // í…Œì´ë¸” ì´ˆê¸°í™”
        function clearTable() {
            dealerCardsContainer.innerHTML = '';
            playerCardsContainer.innerHTML = '';
            dealerScoreDisplay.textContent = '0';
            playerScoreDisplay.textContent = '0';
            resultMessage.style.display = 'none';
            resultMessage.textContent = '';
            resultMessage.className = 'result-message';
        }
        
        // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateGameStatus(message) {
            gameStatus.textContent = message;
        }
        
        // ê²Œì„ ì‹œì‘
        function startGame() {
            if (state.currentBet < state.minBet) {
                alert(`ìµœì†Œ ë² íŒ… ê¸ˆì•¡ì€ ${state.minBet}${currency_name}ì…ë‹ˆë‹¤.`);
                return;
            }
            
            if (state.currentBet > state.maxBet) {
                alert(`ìµœëŒ€ ë² íŒ… ê¸ˆì•¡ì€ ${state.maxBet}${currency_name}ì…ë‹ˆë‹¤.`);
                return;
            }
            
            state.gamePhase = 'dealing';
            stats.totalGames++;
            stats.totalBets += state.currentBet;
            
            // ì”ì•¡ì—ì„œ ë² íŒ… ê¸ˆì•¡ ì°¨ê°
            state.balance -= state.currentBet;
            updateBalance();
            
            clearTable();
            updateGameStatus('ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”!');
            
            // ì¹´ë“œ ì´ˆê¸°í™”
            state.dealerCards = [];
            state.playerCards = [];
            
            // ì¹´ë“œ ë”œë§ (í”Œë ˆì´ì–´, ë”œëŸ¬, í”Œë ˆì´ì–´, ë”œëŸ¬(íˆë“ ))
            state.playerCards.push(drawCard());
            renderCard(state.playerCards[0], playerCardsContainer);
            
            state.dealerCards.push(drawCard());
            renderCard(state.dealerCards[0], dealerCardsContainer);
            
            state.playerCards.push(drawCard());
            renderCard(state.playerCards[1], playerCardsContainer);
            
            state.dealerHiddenCard = drawCard(true);
            state.dealerCards.push(state.dealerHiddenCard);
            renderCard(state.dealerCards[1], dealerCardsContainer);
            
            // ì ìˆ˜ ì—…ë°ì´íŠ¸
            state.playerScore = calculateHandScore(state.playerCards);
            state.dealerScore = calculateHandScore(state.dealerCards);
            
            playerScoreDisplay.textContent = state.playerScore;
            dealerScoreDisplay.textContent = state.dealerScore;
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            dealBtn.disabled = true;
            hitBtn.disabled = false;
            standBtn.disabled = false;
            doubleBtn.disabled = state.currentBet > state.balance;
            
            state.gamePhase = 'player-turn';
            
            // ë¸”ë™ì­ í™•ì¸
            checkForBlackjack();
        }
        
        // ë¸”ë™ì­ í™•ì¸
        function checkForBlackjack() {
            const playerHasBlackjack = state.playerScore === 21 && state.playerCards.length === 2;
            
            if (playerHasBlackjack) {
                // ë”œëŸ¬ì˜ íˆë“  ì¹´ë“œ ê³µê°œ
                revealDealerCard();
                
                const dealerHasBlackjack = state.dealerScore === 21 && state.dealerCards.length === 2;
                
                if (dealerHasBlackjack) {
                    // ë¬´ìŠ¹ë¶€ (ì–‘ìª½ ë‹¤ ë¸”ë™ì­)
                    endGame('push', 'ì–‘ìª½ ëª¨ë‘ ë¸”ë™ì­! ë² íŒ… ê¸ˆì•¡ì„ ëŒë ¤ë°›ìŠµë‹ˆë‹¤.');
                } else {
                    // í”Œë ˆì´ì–´ ë¸”ë™ì­ ìŠ¹ë¦¬
                    stats.blackjacks++;
                    const winAmount = state.currentBet * 2.5;
                    endGame('blackjack', `ë¸”ë™ì­! ${state.currentBet}${currency_name}ì˜ 2.5ë°°ì¸ ${winAmount}${currency_name}ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`, winAmount);
                }
            }
        }
        
        // íˆíŠ¸ (ì¹´ë“œ ë” ë°›ê¸°)
        function hit() {
            if (state.gamePhase !== 'player-turn') return;
            
            const newCard = drawCard();
            state.playerCards.push(newCard);
            renderCard(newCard, playerCardsContainer);
            
            state.playerScore = calculateHandScore(state.playerCards);
            playerScoreDisplay.textContent = state.playerScore;
            
            // ë²„ìŠ¤íŠ¸ ì²´í¬
            if (state.playerScore > 21) {
                endGame('lose', `ë²„ìŠ¤íŠ¸! ì¹´ë“œ í•©ê³„ê°€ ${state.playerScore}ë¡œ 21ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.`);
            }
            
            // ë”ë¸” ë‹¤ìš´ ë²„íŠ¼ ë¹„í™œì„±í™” (íˆíŠ¸ í›„ì—ëŠ” ë”ë¸” ë‹¤ìš´ ë¶ˆê°€)
            doubleBtn.disabled = true;
        }
        
        // ìŠ¤íƒ ë“œ (ì¹´ë“œ ë” ë°›ì§€ ì•Šê¸°)
        function stand() {
            if (state.gamePhase !== 'player-turn') return;
            
            state.gamePhase = 'dealer-turn';
            updateGameStatus('ë”œëŸ¬ ì°¨ë¡€ì…ë‹ˆë‹¤.');
            
            // ë”œëŸ¬ì˜ íˆë“  ì¹´ë“œ ê³µê°œ
            revealDealerCard();
            
            // ë”œëŸ¬ í”Œë ˆì´ (17 ì´ìƒê¹Œì§€ íˆíŠ¸)
            dealerPlay();
        }
        
        // ë”ë¸” ë‹¤ìš´
        function doubleDown() {
            if (state.gamePhase !== 'player-turn' || state.playerCards.length !== 2) return;
            
            // ë² íŒ… ê¸ˆì•¡ ë‘ ë°°ë¡œ
            state.balance -= state.currentBet;
            state.currentBet *= 2;
            updateBalance();
            betAmountDisplay.textContent = state.currentBet;
            
            // ì¹´ë“œ í•œ ì¥ë§Œ ë” ë°›ê³  ì¢…ë£Œ
            const newCard = drawCard();
            state.playerCards.push(newCard);
            renderCard(newCard, playerCardsContainer);
            
            state.playerScore = calculateHandScore(state.playerCards);
            playerScoreDisplay.textContent = state.playerScore;
            
            // ë²„ìŠ¤íŠ¸ ì²´í¬
            if (state.playerScore > 21) {
                endGame('lose', `ë²„ìŠ¤íŠ¸! ì¹´ë“œ í•©ê³„ê°€ ${state.playerScore}ë¡œ 21ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.`);
            } else {
                // ë”œëŸ¬ í„´ìœ¼ë¡œ
                stand();
            }
        }
        
        // ë”œëŸ¬ íˆë“  ì¹´ë“œ ê³µê°œ
        function revealDealerCard() {
            state.dealerHiddenCard.hidden = false;
            dealerCardsContainer.innerHTML = '';
            
            for (let card of state.dealerCards) {
                renderCard(card, dealerCardsContainer);
            }
            
            state.dealerScore = calculateHandScore(state.dealerCards);
            dealerScoreDisplay.textContent = state.dealerScore;
        }
        
        // ë”œëŸ¬ í”Œë ˆì´
        function dealerPlay() {
            // íˆë“  ì¹´ë“œ ê³µê°œ
            revealDealerCard();
            
            // ë”œëŸ¬ëŠ” 17 ì´ìƒê¹Œì§€ íˆíŠ¸
            const dealerTurn = () => {
                if (state.dealerScore < 17) {
                    const newCard = drawCard();
                    state.dealerCards.push(newCard);
                    renderCard(newCard, dealerCardsContainer);
                    
                    state.dealerScore = calculateHandScore(state.dealerCards);
                    dealerScoreDisplay.textContent = state.dealerScore;
                    
                    // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ë¥¼ ìœ„í•œ ì§€ì—°
                    setTimeout(dealerTurn, 1000);
                } else {
                    // ê²°ê³¼ íŒì •
                    determineWinner();
                }
            };
            
            // ë”œëŸ¬ í„´ ì‹œì‘
            setTimeout(dealerTurn, 1000);
        }
        
        // ìŠ¹ì ê²°ì •
        function determineWinner() {
            let result, message, winAmount = 0;
            
            // í”Œë ˆì´ì–´ ë²„ìŠ¤íŠ¸
            if (state.playerScore > 21) {
                result = 'lose';
                message = `ë²„ìŠ¤íŠ¸! ì¹´ë“œ í•©ê³„ê°€ ${state.playerScore}ë¡œ 21ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.`;
            }
            // ë”œëŸ¬ ë²„ìŠ¤íŠ¸
            else if (state.dealerScore > 21) {
                result = 'win';
                winAmount = state.currentBet * 2;
                message = `ë”œëŸ¬ ë²„ìŠ¤íŠ¸! ${state.currentBet}${currency_name}ì˜ 2ë°°ì¸ ${winAmount}${currency_name}ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`;
            }
            // ë™ì 
            else if (state.playerScore === state.dealerScore) {
                result = 'push';
                winAmount = state.currentBet;
                message = `ë¬´ìŠ¹ë¶€! ${state.currentBet}${currency_name}ì„ ëŒë ¤ë°›ìŠµë‹ˆë‹¤.`;
            }
            // í”Œë ˆì´ì–´ ìŠ¹ë¦¬
            else if (state.playerScore > state.dealerScore) {
                result = 'win';
                winAmount = state.currentBet * 2;
                message = `ìŠ¹ë¦¬! ${state.currentBet}${currency_name}ì˜ 2ë°°ì¸ ${winAmount}${currency_name}ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`;
            }
            // ë”œëŸ¬ ìŠ¹ë¦¬
            else {
                result = 'lose';
                message = `íŒ¨ë°°! ë”œëŸ¬ì˜ ${state.dealerScore}ì´ í”Œë ˆì´ì–´ì˜ ${state.playerScore}ë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤.`;
            }
            
            endGame(result, message, winAmount);
        }
        
        // ê²Œì„ ì¢…ë£Œ
        function endGame(result, message, winAmount = 0) {
            state.gamePhase = 'game-over';
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            hitBtn.disabled = true;
            standBtn.disabled = true;
            doubleBtn.disabled = true;
            dealBtn.disabled = false;
            dealBtn.textContent = 'ë‹¤ì‹œ ì‹œì‘';
            
            // íˆë“  ì¹´ë“œ ê³µê°œ
            if (state.dealerHiddenCard && state.dealerHiddenCard.hidden) {
                revealDealerCard();
            }
            
            // ê²°ê³¼ í‘œì‹œ
            resultMessage.textContent = message;
            resultMessage.className = `result-message ${result}`;
            resultMessage.style.display = 'block';
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            switch (result) {
                case 'win':
                    stats.wins++;
                    state.balance += winAmount;
                    stats.totalReturns += winAmount;
                    if (winAmount > stats.maxWin) stats.maxWin = winAmount;
                    break;
                case 'blackjack':
                    stats.wins++;
                    stats.blackjacks++;
                    state.balance += winAmount;
                    stats.totalReturns += winAmount;
                    if (winAmount > stats.maxWin) stats.maxWin = winAmount;
                    break;
                case 'lose':
                    stats.losses++;
                    break;
                case 'push':
                    stats.pushes++;
                    state.balance += winAmount; // ë² íŒ…ì•¡ ë°˜í™˜
                    stats.totalReturns += winAmount;
                    break;
            }
            
            updateBalance();
            updateStatistics();
            updateGameStatus('ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
            
            // ì„œë²„ì— ê²°ê³¼ ì €ì¥
            saveGameResult(state.currentBet, result, winAmount);
            
            // ê²°ê³¼ ëª¨ë‹¬
            showResultModal(result, message, winAmount);
        }
        
        // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
        function showResultModal(result, message, winAmount) {
            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
            const resultIcon = document.getElementById('resultIcon');
            const resultMessage = document.getElementById('resultMessage');
            const resultDetails = document.getElementById('resultDetails');
            const resultModalTitle = document.getElementById('resultModalTitle');
            
            switch (result) {
                case 'win':
                    resultModalTitle.textContent = 'ìŠ¹ë¦¬!';
                    resultIcon.innerHTML = 'ğŸ†';
                    resultMessage.textContent = 'ì¶•í•˜í•©ë‹ˆë‹¤! ì´ê²¼ìŠµë‹ˆë‹¤!';
                    resultDetails.textContent = `${state.currentBet}${currency_name}ì˜ 2ë°°ì¸ ${winAmount}${currency_name}ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`;
                    break;
                case 'blackjack':
                    resultModalTitle.textContent = 'ë¸”ë™ì­!';
                    resultIcon.innerHTML = 'ğŸ°';
                    resultMessage.textContent = 'ì¶•í•˜í•©ë‹ˆë‹¤! ë¸”ë™ì­ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!';
                    resultDetails.textContent = `${state.currentBet}${currency_name}ì˜ 2.5ë°°ì¸ ${winAmount}${currency_name}ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`;
                    break;
                case 'lose':
                    resultModalTitle.textContent = 'íŒ¨ë°°';
                    resultIcon.innerHTML = 'ğŸ˜¢';
                    resultMessage.textContent = 'ì•„ì‰½ê²Œë„ ì¡ŒìŠµë‹ˆë‹¤.';
                    resultDetails.textContent = `${state.currentBet}${currency_name}ì„ ìƒì—ˆìŠµë‹ˆë‹¤.`;
                    break;
                case 'push':
                    resultModalTitle.textContent = 'ë¬´ìŠ¹ë¶€';
                    resultIcon.innerHTML = 'ğŸ¤';
                    resultMessage.textContent = 'ë¬´ìŠ¹ë¶€ì…ë‹ˆë‹¤.';
                    resultDetails.textContent = `ë² íŒ… ê¸ˆì•¡ ${state.currentBet}${currency_name}ì„ ëŒë ¤ë°›ìŠµë‹ˆë‹¤.`;
                    break;
            }
            
            document.getElementById('playAgainBtn').onclick = resetGame;
            
            resultModal.show();
        }
        
        // ê²Œì„ ì¬ì„¤ì •
        function resetGame() {
            state.currentBet = 0;
            betAmountDisplay.textContent = 0;
            dealBtn.textContent = 'ê²Œì„ ì‹œì‘';
            initGame();
        }
        
        // ì”ì•¡ ì—…ë°ì´íŠ¸
        function updateBalance() {
            balanceDisplay.textContent = state.balance;
        }
        
        // ë² íŒ… ê¸ˆì•¡ ì—…ë°ì´íŠ¸
        function updateBet(amount) {
            if (state.gamePhase !== 'betting') return;
            
            // ì”ì•¡ í™•ì¸
            if (amount > state.balance) {
                alert('ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                return;
            }
            
            state.currentBet = amount;
            betAmountDisplay.textContent = amount;
            
            // ì‹œì‘ ë²„íŠ¼ í™œì„±í™” (ìµœì†Œ ë² íŒ…ì•¡ ì´ìƒì´ë©´)
            dealBtn.disabled = state.currentBet < state.minBet;
        }
        
        // ì¹© í´ë¦­ ì´ë²¤íŠ¸
        chips.forEach(chip => {
            chip.addEventListener('click', () => {
                if (state.gamePhase !== 'betting') return;
                
                const chipValue = parseInt(chip.dataset.value);
                
                // ì´ë¯¸ ì„ íƒëœ ì¹©ì´ë©´ ì„ íƒ ì·¨ì†Œ
                if (chip.classList.contains('selected')) {
                    chip.classList.remove('selected');
                    updateBet(0);
                    return;
                }
                
                // ë‹¤ë¥¸ ì¹© ì„ íƒ ì·¨ì†Œ
                chips.forEach(c => c.classList.remove('selected'));
                
                // í•´ë‹¹ ì¹© ì„ íƒ
                chip.classList.add('selected');
                updateBet(chipValue);
            });
        });
        
        // ë² íŒ… ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
        clearBetBtn.addEventListener('click', () => {
            if (state.gamePhase !== 'betting') return;
            
            state.currentBet = 0;
            betAmountDisplay.textContent = 0;
            dealBtn.disabled = true;
            
            // ì¹© ì„ íƒ ì·¨ì†Œ
            chips.forEach(chip => chip.classList.remove('selected'));
        });
        
        // ë²„íŠ¼ ì´ë²¤íŠ¸
        dealBtn.addEventListener('click', () => {
            if (state.gamePhase === 'betting') {
                startGame();
            } else if (state.gamePhase === 'game-over') {
                resetGame();
            }
        });
        
        hitBtn.addEventListener('click', hit);
        standBtn.addEventListener('click', stand);
        doubleBtn.addEventListener('click', doubleDown);
        
        // ì„œë²„ì— ê²Œì„ ê²°ê³¼ ì €ì¥
        function saveGameResult(betAmount, result, winAmount) {
            // AJAX ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— ê²°ê³¼ ì „ì†¡
            fetch('{{ url_for("games.place_bet") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'game_id': 'blackjack',
                    'bet_amount': betAmount,
                    'result': result === 'lose' ? 'lose' : 'win',
                    'win_amount': winAmount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨:', data.message);
                }
            })
            .catch(error => {
                console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
            });
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            document.getElementById('total-games').textContent = stats.totalGames;
            document.getElementById('total-wins').textContent = stats.wins;
            document.getElementById('total-losses').textContent = stats.losses;
            document.getElementById('total-pushes').textContent = stats.pushes;
            document.getElementById('total-blackjacks').textContent = stats.blackjacks;
            document.getElementById('max-win').textContent = `${stats.maxWin}${currency_name}`;
            document.getElementById('total-bets').textContent = `${stats.totalBets}${currency_name}`;
            document.getElementById('total-returns').textContent = `${stats.totalReturns}${currency_name}`;
            
            // ROI ê³„ì‚° (Return on Investment)
            const roi = stats.totalBets > 0 ? ((stats.totalReturns - stats.totalBets) / stats.totalBets * 100).toFixed(2) : '0.00';
            document.getElementById('roi').textContent = `${roi}%`;
        }
        
        // ê²Œì„ ì´ˆê¸°í™”
        initGame();
    });
</script>
{% endblock %}