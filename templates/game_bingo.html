{% extends "layout.html" %}

{% block extra_css %}
<style>
    .game-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .bingo-game {
        background-color: #3949ab;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        margin-bottom: 20px;
        position: relative;
    }
    
    .bingo-title {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .bingo-title span {
        display: inline-block;
        background-color: #fff;
        color: #3949ab;
        font-size: 2rem;
        font-weight: bold;
        padding: 5px 15px;
        border-radius: 10px;
        box-shadow: 0 3px 5px rgba(0,0,0,0.2);
        margin: 0 5px;
    }
    
    .balance-display {
        background-color: rgba(0,0,0,0.5);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        margin-bottom: 20px;
        display: inline-block;
    }
    
    .bingo-board {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        max-width: 500px;
        margin: 0 auto 30px;
    }
    
    .bingo-cell {
        background-color: white;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
        color: #3949ab;
        box-shadow: 0 3px 5px rgba(0,0,0,0.2);
    }
    
    .bingo-cell:hover:not(.marked):not(.free) {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .bingo-cell.marked {
        background-color: #ef5350;
        color: white;
        transform: rotate(3deg);
        animation: marking 0.3s ease;
    }
    
    .bingo-cell.bingo-line {
        animation: bingo-line 1s infinite alternate;
    }
    
    .bingo-cell.free {
        background-color: #ffb300;
        color: #fff;
        font-size: 1rem;
    }
    
    @keyframes marking {
        0% { transform: scale(1); }
        50% { transform: scale(1.1) rotate(5deg); }
        100% { transform: scale(1) rotate(3deg); }
    }
    
    @keyframes bingo-line {
        0% { background-color: #ef5350; box-shadow: 0 0 10px #ef5350; }
        100% { background-color: #ffb300; box-shadow: 0 0 20px #ffb300; }
    }
    
    .number-display {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .number-display h4 {
        color: rgba(255,255,255,0.8);
        margin-bottom: 15px;
    }
    
    .drawn-number {
        background-color: #fff;
        color: #3949ab;
        font-size: 2.5rem;
        font-weight: bold;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .number-history {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 5px;
        max-width: 600px;
        margin: 15px auto;
    }
    
    .history-number {
        background-color: rgba(255,255,255,0.3);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .bet-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .btn-bingo {
        background-color: #ef5350;
        color: white;
        font-size: 1.2rem;
        padding: 15px 30px;
        border-radius: 50px;
        border: none;
        box-shadow: 0 4px 0 #b71c1c;
        transition: all 0.2s;
        font-weight: bold;
    }
    
    .btn-bingo:hover {
        background-color: #e53935;
        transform: translateY(-2px);
    }
    
    .btn-bingo:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 #b71c1c;
    }
    
    .btn-bingo:disabled {
        background-color: #bdbdbd;
        box-shadow: 0 4px 0 #757575;
        cursor: not-allowed;
    }
    
    .result-message {
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin: 20px auto;
        max-width: 400px;
        display: none;
    }
    
    .result-message.win {
        background-color: #4caf50;
    }
    
    .result-message.lose {
        background-color: #f44336;
    }
    
    .actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
    }
    
    .progress-bar-container {
        background-color: rgba(255,255,255,0.2);
        border-radius: 10px;
        height: 20px;
        width: 100%;
        max-width: 500px;
        margin: 20px auto 0;
        overflow: hidden;
    }
    
    .progress-bar {
        background-color: #ff5722;
        height: 100%;
        width: 0%;
        transition: width 0.3s ease;
    }
    
    .progress-label {
        text-align: center;
        color: rgba(255,255,255,0.8);
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    .game-status {
        text-align: center;
        margin: 20px 0;
        font-size: 1.2rem;
        color: rgba(255,255,255,0.9);
        font-weight: bold;
    }
    
    .prize-info {
        text-align: center;
        margin: 20px 0;
        color: rgba(255,255,255,0.9);
        background-color: rgba(0,0,0,0.2);
        padding: 10px;
        border-radius: 10px;
        max-width: 500px;
        margin: 0 auto 20px;
    }
    
    .prize-info h4 {
        margin-bottom: 10px;
        color: #ffb300;
    }
    
    .prize-table {
        width: 100%;
        color: white;
        font-size: 0.9rem;
    }
    
    .prize-table td {
        padding: 5px 10px;
    }
    
    .payout-value {
        font-weight: bold;
        color: #ffb300;
    }
    
    .statistics {
        background-color: #f5f5f5;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .statistics h4 {
        margin-top: 0;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    
    .rules-section {
        background-color: #fff;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .rules-section h4 {
        margin-top: 0;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }
    
    .rule-item {
        margin-bottom: 10px;
    }
    
    #bingo-button {
        position: relative;
        overflow: hidden;
    }
    
    #bingo-button.bingo-win::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
        animation: ripple 1s linear infinite;
    }
    
    @keyframes ripple {
        0% { transform: scale(0.3); opacity: 1; }
        100% { transform: scale(1); opacity: 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="game-container">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="mb-0"><i class="fas fa-th-large me-2"></i>ë¹™ê³  ê²Œì„</h2>
            <a href="{{ url_for('games.index') }}" class="btn btn-outline-light btn-sm">
                <i class="fas fa-arrow-left me-1"></i>ê²Œì„ ëª©ë¡
            </a>
        </div>
        <div class="card-body">
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle me-2"></i>ë¹™ê³ íŒì—ì„œ ìˆ«ìë¥¼ ì„ íƒí•˜ê³  ì¶”ì²¨ëœ ìˆ«ìì™€ ì¼ì¹˜í•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤. í•œ ì¤„ì´ ì™„ì„±ë˜ë©´ ë¹™ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒê¸ˆì„ íšë“í•˜ì„¸ìš”!
            </div>
            
            <div class="bingo-game">
                <div class="text-center">
                    <div class="balance-display">
                        <i class="fas fa-coins me-2"></i>í˜„ì¬ ì”ì•¡: <span id="balance">{{ g.user.balance }}</span>{{ currency_name }}
                    </div>
                </div>
                
                <div class="bingo-title">
                    <span>B</span>
                    <span>I</span>
                    <span>N</span>
                    <span>G</span>
                    <span>O</span>
                </div>
                
                <div class="bingo-board" id="bingo-board">
                    <!-- ë¹™ê³ íŒì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë™ì  ìƒì„± -->
                </div>
                
                <div class="number-display">
                    <h4>ì¶”ì²¨ëœ ìˆ«ì</h4>
                    <div class="drawn-number" id="current-number">-</div>
                    <div class="number-history" id="number-history">
                        <!-- ì¶”ì²¨ ê¸°ë¡ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <div class="prize-info">
                    <h4>ìƒê¸ˆ ì •ë³´</h4>
                    <table class="prize-table">
                        <tr>
                            <td>1ì¤„ ë¹™ê³ </td>
                            <td class="payout-value">ë² íŒ…ì•¡ì˜ 2ë°°</td>
                        </tr>
                        <tr>
                            <td>2ì¤„ ë¹™ê³ </td>
                            <td class="payout-value">ë² íŒ…ì•¡ì˜ 5ë°°</td>
                        </tr>
                        <tr>
                            <td>3ì¤„ ë¹™ê³ </td>
                            <td class="payout-value">ë² íŒ…ì•¡ì˜ 10ë°°</td>
                        </tr>
                        <tr>
                            <td>4ì¤„ ë¹™ê³ </td>
                            <td class="payout-value">ë² íŒ…ì•¡ì˜ 20ë°°</td>
                        </tr>
                        <tr>
                            <td>5ì¤„ ë¹™ê³  (ë¸”ë™ì•„ì›ƒ)</td>
                            <td class="payout-value">ë² íŒ…ì•¡ì˜ 50ë°°</td>
                        </tr>
                    </table>
                </div>
                
                <div class="game-status" id="game-status">ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”!</div>
                
                <div class="bet-controls">
                    <button class="btn btn-outline-light" id="decrease-bet">
                        <i class="fas fa-minus"></i>
                    </button>
                    <div class="input-group" style="width: 200px;">
                        <span class="input-group-text">ë°°íŒ…ê¸ˆì•¡</span>
                        <input type="number" class="form-control text-center" id="bet-amount" value="{{ min_bet }}" min="{{ min_bet }}" max="{{ max_bet }}">
                        <span class="input-group-text">{{ currency_name }}</span>
                    </div>
                    <button class="btn btn-outline-light" id="increase-bet">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <div class="actions">
                    <button class="btn btn-bingo" id="start-button">
                        <i class="fas fa-play me-2"></i>ê²Œì„ ì‹œì‘
                    </button>
                    <button class="btn btn-bingo" id="draw-button" disabled>
                        <i class="fas fa-random me-2"></i>ìˆ«ì ì¶”ì²¨
                    </button>
                    <button class="btn btn-bingo" id="bingo-button" disabled>
                        <i class="fas fa-trophy me-2"></i>ë¹™ê³ !
                    </button>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="progress-label" id="progress-label">ì¶”ì²¨ ì§„í–‰ë¥ : 0/75</div>
                
                <div class="result-message" id="result-message"></div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="rules-section">
                        <h4><i class="fas fa-book me-2"></i>ê²Œì„ ê·œì¹™</h4>
                        <div class="rule-item">
                            <strong>ê²Œì„ ë°©ë²•:</strong> 5Ã—5 ë¹™ê³ íŒì—ì„œ ì¶”ì²¨ë˜ëŠ” ìˆ«ìì™€ ì¼ì¹˜í•˜ë©´ í•´ë‹¹ ì¹¸ì´ í‘œì‹œë©ë‹ˆë‹¤.
                        </div>
                        <div class="rule-item">
                            <strong>ë¹™ê³ :</strong> ê°€ë¡œ, ì„¸ë¡œ, ëŒ€ê°ì„ ìœ¼ë¡œ 5ê°œì˜ ì¹¸ì´ ì—°ì†ìœ¼ë¡œ í‘œì‹œë˜ë©´ í•œ ì¤„ ë¹™ê³ ì…ë‹ˆë‹¤.
                        </div>
                        <div class="rule-item">
                            <strong>í”„ë¦¬ ìŠ¤í˜ì´ìŠ¤:</strong> ì¤‘ì•™ ì¹¸ì€ í•­ìƒ ë¬´ë£Œë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                        </div>
                        <div class="rule-item">
                            <strong>ìŠ¹ë¦¬ ì¡°ê±´:</strong> í•œ ì¤„ ì´ìƒì˜ ë¹™ê³ ê°€ ì™„ì„±ë˜ë©´ "ë¹™ê³ " ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒê¸ˆì„ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                        <div class="rule-item">
                            <strong>ìƒê¸ˆ:</strong> í•œ ê²Œì„ì—ì„œ ìµœëŒ€ 5ì¤„ì˜ ë¹™ê³ ë¥¼ ë‹¬ì„±í•  ìˆ˜ ìˆìœ¼ë©°, ì¤„ ìˆ˜ì— ë”°ë¼ ìƒê¸ˆì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="statistics">
                        <h4><i class="fas fa-chart-pie me-2"></i>ë‚´ ê²Œì„ í†µê³„</h4>
                        <div class="stat-item">
                            <span>ì´ ê²Œì„ ìˆ˜:</span>
                            <span id="total-games">0</span>
                        </div>
                        <div class="stat-item">
                            <span>ìŠ¹ë¦¬:</span>
                            <span id="total-wins">0</span>
                        </div>
                        <div class="stat-item">
                            <span>íŒ¨ë°°:</span>
                            <span id="total-losses">0</span>
                        </div>
                        <div class="stat-item">
                            <span>ìµœë‹¤ ë¹™ê³  ì¤„ ìˆ˜:</span>
                            <span id="max-lines">0</span>
                        </div>
                        <div class="stat-item">
                            <span>ë¸”ë™ì•„ì›ƒ íšŸìˆ˜:</span>
                            <span id="total-blackouts">0</span>
                        </div>
                        <div class="stat-item">
                            <span>ìµœëŒ€ ë‹¹ì²¨ê¸ˆ:</span>
                            <span id="max-win">0{{ currency_name }}</span>
                        </div>
                        <div class="stat-item">
                            <span>ì´ íˆ¬ìê¸ˆ:</span>
                            <span id="total-bets">0{{ currency_name }}</span>
                        </div>
                        <div class="stat-item">
                            <span>ì´ íšë“ê¸ˆ:</span>
                            <span id="total-returns">0{{ currency_name }}</span>
                        </div>
                        <div class="stat-item">
                            <span>ìˆ˜ìµë¥ :</span>
                            <span id="roi">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ê²Œì„ ê²°ê³¼ ëª¨ë‹¬ -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">ê²Œì„ ê²°ê³¼</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" id="resultModalBody">
                <div id="resultIcon" class="mb-3" style="font-size: 48px;"></div>
                <h4 id="resultMessage" class="mb-3"></h4>
                <p id="resultDetails" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" id="playAgainBtn" data-bs-dismiss="modal">ë‹¤ì‹œ í”Œë ˆì´</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ê²Œì„ ì„¤ì • ë° ë³€ìˆ˜
        const boardSize = 5;
        const minNumber = 1;
        const maxNumber = 75;
        const maxDraws = 40; // í•œ ê²Œì„ë‹¹ ìµœëŒ€ ì¶”ì²¨ íšŸìˆ˜
        
        const state = {
            board: [],
            drawnNumbers: [],
            currentDrawIndex: 0,
            bingoLines: 0,
            bingoCompleted: false,
            gamePhase: 'betting', // betting, playing, completed
            currentBet: {{ min_bet }},
            balance: {{ g.user.balance }},
            minBet: {{ min_bet }},
            maxBet: {{ max_bet }}
        };
        
        // ê²Œì„ í†µê³„
        const stats = {
            totalGames: 0,
            wins: 0,
            losses: 0,
            maxLines: 0,
            blackouts: 0,
            maxWin: 0,
            totalBets: 0,
            totalReturns: 0
        };
        
        // DOM ìš”ì†Œ
        const bingoBoard = document.getElementById('bingo-board');
        const currentNumberDisplay = document.getElementById('current-number');
        const numberHistory = document.getElementById('number-history');
        const startButton = document.getElementById('start-button');
        const drawButton = document.getElementById('draw-button');
        const bingoButton = document.getElementById('bingo-button');
        const resultMessage = document.getElementById('result-message');
        const gameStatus = document.getElementById('game-status');
        const progressBar = document.getElementById('progress-bar');
        const progressLabel = document.getElementById('progress-label');
        const balanceDisplay = document.getElementById('balance');
        const betAmount = document.getElementById('bet-amount');
        const decreaseBet = document.getElementById('decrease-bet');
        const increaseBet = document.getElementById('increase-bet');
        
        // ë¹™ê³ íŒ ìƒì„±
        function createBingoBoard() {
            // ê¸°ì¡´ ë¹™ê³ íŒ ì´ˆê¸°í™”
            bingoBoard.innerHTML = '';
            state.board = [];
            
            // B(1-15), I(16-30), N(31-45), G(46-60), O(61-75) ì»¬ëŸ¼ ìƒì„±
            const columns = [
                getRandomNumbers(1, 15, 5),
                getRandomNumbers(16, 30, 5),
                getRandomNumbers(31, 45, 5),
                getRandomNumbers(46, 60, 5),
                getRandomNumbers(61, 75, 5)
            ];
            
            // 5x5 ë³´ë“œ ìƒì„±
            for (let row = 0; row < boardSize; row++) {
                let rowData = [];
                
                for (let col = 0; col < boardSize; col++) {
                    let cellValue = columns[col][row];
                    
                    // ì¤‘ì•™ ì¹¸ì€ FREE
                    if (row === 2 && col === 2) {
                        cellValue = 'FREE';
                    }
                    
                    // ì…€ ê°ì²´ ìƒì„±
                    const cell = {
                        value: cellValue,
                        marked: cellValue === 'FREE', // FREEëŠ” ì´ë¯¸ í‘œì‹œë¨
                        row: row,
                        col: col
                    };
                    
                    rowData.push(cell);
                    
                    // ì…€ DOM ìš”ì†Œ ìƒì„±
                    const cellElement = document.createElement('div');
                    cellElement.className = 'bingo-cell' + (cell.marked ? ' marked free' : '');
                    cellElement.textContent = cell.value;
                    cellElement.dataset.row = row;
                    cellElement.dataset.col = col;
                    
                    bingoBoard.appendChild(cellElement);
                }
                
                state.board.push(rowData);
            }
            
            // ëª¨ë“  ì…€ì— ëŒ€í•œ í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì • (ë¯¸ë¦¬ ìƒì„±í•˜ì§€ë§Œ ì‹¤ì œ ì‚¬ìš©ì€ ê²Œì„ ì¤‘ì—ë§Œ)
            document.querySelectorAll('.bingo-cell').forEach(cell => {
                cell.addEventListener('click', function() {
                    // ì´ë¯¸ í‘œì‹œëœ ì…€ì´ê±°ë‚˜ ê²Œì„ ì¤‘ì´ ì•„ë‹Œ ê²½ìš° ë¬´ì‹œ
                    if (cell.classList.contains('marked') || state.gamePhase !== 'playing') {
                        return;
                    }
                    
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    const cellValue = state.board[row][col].value;
                    
                    // í˜„ì¬ê¹Œì§€ ì¶”ì²¨ëœ ìˆ«ì ì¤‘ì— ìˆëŠ”ì§€ í™•ì¸
                    if (state.drawnNumbers.includes(cellValue)) {
                        // í‘œì‹œí•˜ê¸°
                        cell.classList.add('marked');
                        state.board[row][col].marked = true;
                        
                        // ë¹™ê³  ë¼ì¸ í™•ì¸
                        checkForBingo();
                    }
                });
            });
        }
        
        // ëœë¤ ìˆ«ì ë°°ì—´ ìƒì„± (íŠ¹ì • ë²”ìœ„ì—ì„œ ì¤‘ë³µ ì—†ì´)
        function getRandomNumbers(min, max, count) {
            const numbers = [];
            
            while (numbers.length < count) {
                const num = Math.floor(Math.random() * (max - min + 1)) + min;
                if (!numbers.includes(num)) {
                    numbers.push(num);
                }
            }
            
            return numbers;
        }
        
        // ìˆ«ì ì¶”ì²¨
        function drawNumber() {
            if (state.currentDrawIndex >= maxDraws) {
                endGame(false, 'ë” ì´ìƒ ì¶”ì²¨í•  ìˆ«ìê°€ ì—†ìŠµë‹ˆë‹¤. ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            let randomNumber;
            
            // ì´ë¯¸ ì¶”ì²¨ëœ ìˆ«ìëŠ” ì œì™¸
            do {
                randomNumber = Math.floor(Math.random() * maxNumber) + minNumber;
            } while (state.drawnNumbers.includes(randomNumber));
            
            state.drawnNumbers.push(randomNumber);
            state.currentDrawIndex++;
            
            // í™”ë©´ ì—…ë°ì´íŠ¸
            currentNumberDisplay.textContent = randomNumber;
            
            // ìˆ«ì íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            const historyItem = document.createElement('div');
            historyItem.className = 'history-number';
            historyItem.textContent = randomNumber;
            numberHistory.appendChild(historyItem);
            
            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            updateProgressBar();
            
            // ìë™ í‘œì‹œ (ë¹™ê³ íŒì—ì„œ í•´ë‹¹ ìˆ«ì ì°¾ì•„ í‘œì‹œ)
            document.querySelectorAll('.bingo-cell').forEach(cell => {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                
                if (
                    row !== undefined && 
                    col !== undefined && 
                    state.board[row][col].value === randomNumber
                ) {
                    cell.classList.add('marked');
                    state.board[row][col].marked = true;
                }
            });
            
            // ë¹™ê³  í™•ì¸
            checkForBingo();
            
            // ìµœëŒ€ ì¶”ì²¨ íšŸìˆ˜ ë„ë‹¬ í™•ì¸
            if (state.currentDrawIndex >= maxDraws) {
                drawButton.disabled = true;
                gameStatus.textContent = 'ëª¨ë“  ìˆ«ìê°€ ì¶”ì²¨ë˜ì—ˆìŠµë‹ˆë‹¤.';
                
                if (state.bingoLines === 0) {
                    setTimeout(() => {
                        endGame(false, 'ì•„ì‰½ê²Œë„ ë¹™ê³ ë¥¼ ì™„ì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }, 1500);
                }
            }
        }
        
        // ì§„í–‰ë¥  í‘œì‹œë°” ì—…ë°ì´íŠ¸
        function updateProgressBar() {
            const percentage = (state.currentDrawIndex / maxDraws) * 100;
            progressBar.style.width = `${percentage}%`;
            progressLabel.textContent = `ì¶”ì²¨ ì§„í–‰ë¥ : ${state.currentDrawIndex}/${maxDraws}`;
        }
        
        // ë¹™ê³  ë¼ì¸ í™•ì¸
        function checkForBingo() {
            // ì´ì „ ë¹™ê³  ë¼ì¸ í‘œì‹œ ì œê±°
            document.querySelectorAll('.bingo-line').forEach(cell => {
                cell.classList.remove('bingo-line');
            });
            
            let bingoLines = 0;
            const bingoLineCoords = [];
            
            // ê°€ë¡œ ì¤„ ì²´í¬
            for (let row = 0; row < boardSize; row++) {
                let isRowBingo = true;
                for (let col = 0; col < boardSize; col++) {
                    if (!state.board[row][col].marked) {
                        isRowBingo = false;
                        break;
                    }
                }
                
                if (isRowBingo) {
                    bingoLines++;
                    bingoLineCoords.push(...Array(boardSize).fill().map((_, col) => ({row, col})));
                }
            }
            
            // ì„¸ë¡œ ì¤„ ì²´í¬
            for (let col = 0; col < boardSize; col++) {
                let isColBingo = true;
                for (let row = 0; row < boardSize; row++) {
                    if (!state.board[row][col].marked) {
                        isColBingo = false;
                        break;
                    }
                }
                
                if (isColBingo) {
                    bingoLines++;
                    bingoLineCoords.push(...Array(boardSize).fill().map((_, row) => ({row, col})));
                }
            }
            
            // ëŒ€ê°ì„  ì²´í¬ (ì¢Œìƒë‹¨ì—ì„œ ìš°í•˜ë‹¨)
            let isDiag1Bingo = true;
            for (let i = 0; i < boardSize; i++) {
                if (!state.board[i][i].marked) {
                    isDiag1Bingo = false;
                    break;
                }
            }
            
            if (isDiag1Bingo) {
                bingoLines++;
                bingoLineCoords.push(...Array(boardSize).fill().map((_, i) => ({row: i, col: i})));
            }
            
            // ëŒ€ê°ì„  ì²´í¬ (ìš°ìƒë‹¨ì—ì„œ ì¢Œí•˜ë‹¨)
            let isDiag2Bingo = true;
            for (let i = 0; i < boardSize; i++) {
                if (!state.board[i][boardSize - 1 - i].marked) {
                    isDiag2Bingo = false;
                    break;
                }
            }
            
            if (isDiag2Bingo) {
                bingoLines++;
                bingoLineCoords.push(...Array(boardSize).fill().map((_, i) => ({row: i, col: boardSize - 1 - i})));
            }
            
            // ë¹™ê³  ë¼ì¸ í‘œì‹œ
            const uniqueCoords = bingoLineCoords.filter(
                (coord, index, self) => 
                    self.findIndex(c => c.row === coord.row && c.col === coord.col) === index
            );
            
            uniqueCoords.forEach(coord => {
                const cell = document.querySelector(`.bingo-cell[data-row="${coord.row}"][data-col="${coord.col}"]`);
                if (cell) {
                    cell.classList.add('bingo-line');
                }
            });
            
            // ë¹™ê³  ë¼ì¸ ì—…ë°ì´íŠ¸
            state.bingoLines = bingoLines;
            
            // ë¹™ê³  ë²„íŠ¼ í™œì„±í™” (ë¹™ê³ ê°€ ìˆê³  ì´ì „ì— ì™„ë£Œí•˜ì§€ ì•Šì€ ê²½ìš°)
            if (bingoLines > 0 && !state.bingoCompleted) {
                bingoButton.disabled = false;
                bingoButton.classList.add('bingo-win');
                gameStatus.textContent = `${bingoLines}ì¤„ì˜ ë¹™ê³ ê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ë¹™ê³  ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”!`;
            } else {
                bingoButton.classList.remove('bingo-win');
            }
        }
        
        // ê²Œì„ ì‹œì‘
        function startGame() {
            const bet = parseInt(betAmount.value);
            
            // ë² íŒ… ê¸ˆì•¡ ìœ íš¨ì„± ê²€ì‚¬
            if (isNaN(bet) || bet < state.minBet || bet > state.maxBet) {
                alert(`ë² íŒ… ê¸ˆì•¡ì€ ${state.minBet}${currency_name}ì—ì„œ ${state.maxBet}${currency_name} ì‚¬ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
                return;
            }
            
            if (bet > state.balance) {
                alert('ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ê²Œì„ ì´ˆê¸°í™”
            state.currentBet = bet;
            state.balance -= bet;
            state.drawnNumbers = [];
            state.currentDrawIndex = 0;
            state.bingoLines = 0;
            state.bingoCompleted = false;
            state.gamePhase = 'playing';
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            stats.totalGames++;
            stats.totalBets += bet;
            
            // ì”ì•¡ í‘œì‹œ ì—…ë°ì´íŠ¸
            balanceDisplay.textContent = state.balance;
            
            // ë¹™ê³ íŒ ìƒì„±
            createBingoBoard();
            
            // íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
            numberHistory.innerHTML = '';
            currentNumberDisplay.textContent = '-';
            
            // ì§„í–‰ë¥  ì´ˆê¸°í™”
            progressBar.style.width = '0%';
            progressLabel.textContent = `ì¶”ì²¨ ì§„í–‰ë¥ : 0/${maxDraws}`;
            
            // ë©”ì‹œì§€ ë° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            resultMessage.style.display = 'none';
            gameStatus.textContent = 'ìˆ«ì ì¶”ì²¨ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê²Œì„ì„ ì§„í–‰í•˜ì„¸ìš”!';
            startButton.disabled = true;
            drawButton.disabled = false;
            bingoButton.disabled = true;
            
            // ìë™ìœ¼ë¡œ ì²« ë²ˆì§¸ ìˆ«ì ì¶”ì²¨
            drawNumber();
        }
        
        // ë¹™ê³  ì™„ë£Œ (ìŠ¹ë¦¬)
        function completeBingo() {
            if (state.bingoLines === 0 || state.bingoCompleted) {
                return;
            }
            
            state.bingoCompleted = true;
            bingoButton.disabled = true;
            
            // ìŠ¹ë¦¬ ê¸ˆì•¡ ê³„ì‚°
            let multiplier = 0;
            switch(state.bingoLines) {
                case 1: multiplier = 2; break;
                case 2: multiplier = 5; break;
                case 3: multiplier = 10; break;
                case 4: multiplier = 20; break;
                case 5: // ëª¨ë“  ë¼ì¸ (ë¸”ë™ì•„ì›ƒ)
                case 6:
                case 7:
                case 8:
                case 9:
                case 10:
                case 11:
                case 12:
                    multiplier = 50; 
                    stats.blackouts++;
                    break;
                default: multiplier = state.bingoLines * 2; // í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°ë¥¼ ìœ„í•œ ê¸°ë³¸ê°’
            }
            
            const winAmount = state.currentBet * multiplier;
            
            // ê²Œì„ ì¢…ë£Œ
            endGame(true, `ì¶•í•˜í•©ë‹ˆë‹¤! ${state.bingoLines}ì¤„ì˜ ë¹™ê³ ë¡œ ${state.currentBet}${currency_name}ì˜ ${multiplier}ë°°ì¸ ${winAmount}${currency_name}ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`, winAmount);
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            if (state.bingoLines > stats.maxLines) {
                stats.maxLines = state.bingoLines;
            }
        }
        
        // ê²Œì„ ì¢…ë£Œ
        function endGame(isWin, message, winAmount = 0) {
            state.gamePhase = 'completed';
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            drawButton.disabled = true;
            bingoButton.disabled = true;
            startButton.disabled = false;
            startButton.innerHTML = '<i class="fas fa-redo me-2"></i>ë‹¤ì‹œ ì‹œì‘';
            
            // ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
            resultMessage.textContent = message;
            resultMessage.className = `result-message ${isWin ? 'win' : 'lose'}`;
            resultMessage.style.display = 'block';
            
            // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
            gameStatus.textContent = isWin ? 'ì¶•í•˜í•©ë‹ˆë‹¤! ë¹™ê³ ë¥¼ ì™„ì„±í–ˆìŠµë‹ˆë‹¤!' : 'ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            if (isWin) {
                stats.wins++;
                state.balance += winAmount;
                stats.totalReturns += winAmount;
                
                if (winAmount > stats.maxWin) {
                    stats.maxWin = winAmount;
                }
            } else {
                stats.losses++;
            }
            
            // ì”ì•¡ ì—…ë°ì´íŠ¸
            balanceDisplay.textContent = state.balance;
            
            // í†µê³„ í™”ë©´ ì—…ë°ì´íŠ¸
            updateStatistics();
            
            // ì„œë²„ì— ê²°ê³¼ ì €ì¥
            saveGameResult(state.currentBet, isWin ? 'win' : 'lose', winAmount);
            
            // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
            showResultModal(isWin, message, winAmount);
        }
        
        // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
        function showResultModal(isWin, message, winAmount) {
            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
            const resultIcon = document.getElementById('resultIcon');
            const resultMessage = document.getElementById('resultMessage');
            const resultDetails = document.getElementById('resultDetails');
            const resultModalTitle = document.getElementById('resultModalTitle');
            
            if (isWin) {
                resultModalTitle.textContent = 'ì¶•í•˜í•©ë‹ˆë‹¤!';
                resultIcon.innerHTML = 'ğŸ‰';
                resultMessage.textContent = `${state.bingoLines}ì¤„ì˜ ë¹™ê³ ë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!`;
                resultDetails.textContent = `${state.currentBet}${currency_name}ì˜ ë°°ë‹¹ê¸ˆìœ¼ë¡œ ${winAmount}${currency_name}ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`;
            } else {
                resultModalTitle.textContent = 'ì•„ì‰½ë„¤ìš”';
                resultIcon.innerHTML = 'ğŸ˜¢';
                resultMessage.textContent = 'ì´ë²ˆì—ëŠ” ë¹™ê³ ë¥¼ ë‹¬ì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                resultDetails.textContent = `${state.currentBet}${currency_name}ì„ ìƒì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!`;
            }
            
            document.getElementById('playAgainBtn').onclick = function() {
                resetGame();
            };
            
            resultModal.show();
        }
        
        // ê²Œì„ ì¬ì„¤ì •
        function resetGame() {
            state.gamePhase = 'betting';
            startButton.innerHTML = '<i class="fas fa-play me-2"></i>ê²Œì„ ì‹œì‘';
            gameStatus.textContent = 'ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”!';
            resultMessage.style.display = 'none';
            
            // ë¹™ê³ íŒ ì´ˆê¸°í™”
            createBingoBoard();
            
            // íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
            numberHistory.innerHTML = '';
            currentNumberDisplay.textContent = '-';
            
            // ì§„í–‰ë¥  ì´ˆê¸°í™”
            progressBar.style.width = '0%';
            progressLabel.textContent = `ì¶”ì²¨ ì§„í–‰ë¥ : 0/${maxDraws}`;
        }
        
        // ì„œë²„ì— ê²Œì„ ê²°ê³¼ ì €ì¥
        function saveGameResult(betAmount, result, winAmount) {
            // AJAX ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— ê²°ê³¼ ì „ì†¡
            fetch('{{ url_for("games.place_bet") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'game_id': 'bingo',
                    'bet_amount': betAmount,
                    'result': result,
                    'win_amount': winAmount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨:', data.message);
                }
            })
            .catch(error => {
                console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
            });
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            document.getElementById('total-games').textContent = stats.totalGames;
            document.getElementById('total-wins').textContent = stats.wins;
            document.getElementById('total-losses').textContent = stats.losses;
            document.getElementById('max-lines').textContent = stats.maxLines;
            document.getElementById('total-blackouts').textContent = stats.blackouts;
            document.getElementById('max-win').textContent = `${stats.maxWin}${currency_name}`;
            document.getElementById('total-bets').textContent = `${stats.totalBets}${currency_name}`;
            document.getElementById('total-returns').textContent = `${stats.totalReturns}${currency_name}`;
            
            // ROI ê³„ì‚° (Return on Investment)
            const roi = stats.totalBets > 0 ? ((stats.totalReturns - stats.totalBets) / stats.totalBets * 100).toFixed(2) : '0.00';
            document.getElementById('roi').textContent = `${roi}%`;
        }
        
        // ë°°íŒ… ê¸ˆì•¡ ì œì–´
        decreaseBet.addEventListener('click', function() {
            let currentBet = parseInt(betAmount.value);
            if (currentBet > state.minBet) {
                betAmount.value = currentBet - 100;
            }
        });
        
        increaseBet.addEventListener('click', function() {
            let currentBet = parseInt(betAmount.value);
            if (currentBet < state.maxBet && currentBet < state.balance) {
                betAmount.value = currentBet + 100;
            }
        });
        
        betAmount.addEventListener('change', function() {
            let value = parseInt(this.value);
            if (value < state.minBet) this.value = state.minBet;
            if (value > state.maxBet) this.value = state.maxBet;
            if (value > state.balance) this.value = state.balance;
        });
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        startButton.addEventListener('click', startGame);
        drawButton.addEventListener('click', drawNumber);
        bingoButton.addEventListener('click', completeBingo);
        
        // ì´ˆê¸° ë¹™ê³ íŒ ìƒì„±
        createBingoBoard();
    });
</script>
{% endblock %}